<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ad Pilot - Video Generator</title>
<link rel="icon" type="image/svg+xml" href="favicon.svg">
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
min-height: 100vh;
padding: 40px 20px;
}

.container {
max-width: 600px;
margin: 0 auto;
background: white;
border-radius: 20px;
padding: 40px;
box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

h1 {
color: #333;
margin-bottom: 10px;
font-size: 32px;
}

.subtitle {
color: #666;
margin-bottom: 30px;
font-size: 16px;
}

.form-group {
margin-bottom: 25px;
}

label {
display: block;
margin-bottom: 8px;
color: #333;
font-weight: 600;
font-size: 14px;
}

.label-description {
font-weight: 400;
color: #666;
font-size: 13px;
margin-top: 4px;
}

input[type="text"],
input[type="email"],
select {
width: 100%;
padding: 12px;
border: 2px solid #e0e0e0;
border-radius: 8px;
font-size: 16px;
transition: border-color 0.3s;
}

input[type="text"]:focus,
input[type="email"]:focus,
select:focus {
outline: none;
border-color: #667eea;
}

/* Checkbox styling */
.checkbox-group {
margin-left: 20px;
padding: 15px;
border-left: 3px solid #667eea;
background: #f8f9ff;
border-radius: 8px;
margin-top: 10px;
}

.checkbox-label {
display: flex;
align-items: center;
cursor: pointer;
}

input[type="checkbox"] {
width: 20px;
height: 20px;
margin-right: 10px;
cursor: pointer;
}

.vehicle-group {
display: flex;
gap: 10px;
margin-bottom: 15px;
align-items: center;
}

.vehicle-group select {
flex: 1;
}

.remove-vehicle {
padding: 12px 16px;
background: #000000;
color: white;
border: none;
border-radius: 8px;
cursor: pointer;
font-size: 18px;
font-weight: 600;
transition: background 0.2s;
}

.remove-vehicle:hover {
background: #333333;
}

.add-vehicle {
width: 100%;
padding: 12px;
background: #f0f0f0;
color: #333;
border: 2px dashed #ccc;
border-radius: 8px;
cursor: pointer;
font-size: 14px;
font-weight: 600;
transition: all 0.2s;
}

.add-vehicle:hover:not(:disabled) {
background: #e0e0e0;
border-color: #999;
}

.add-vehicle:disabled {
opacity: 0.5;
cursor: not-allowed;
}

button[type="submit"],
.btn-primary {
width: 100%;
padding: 16px;
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
color: white;
border: none;
border-radius: 8px;
font-size: 18px;
font-weight: 600;
cursor: pointer;
transition: transform 0.2s;
}

button[type="submit"]:hover,
.btn-primary:hover {
transform: translateY(-2px);
}

button[type="submit"]:active,
.btn-primary:active {
transform: translateY(0);
}

button[type="submit"]:disabled,
.btn-primary:disabled {
opacity: 0.5;
cursor: not-allowed;
transform: none;
}

.btn-secondary {
width: 100%;
padding: 14px;
background: #f0f0f0;
color: #333;
border: 2px solid #ddd;
border-radius: 8px;
font-size: 16px;
font-weight: 600;
cursor: pointer;
transition: all 0.2s;
}

.btn-secondary:hover:not(:disabled) {
background: #e0e0e0;
border-color: #bbb;
}

.btn-secondary:disabled {
opacity: 0.5;
cursor: not-allowed;
}

.button-group {
display: flex;
gap: 12px;
margin-top: 20px;
}

.button-group button {
flex: 1;
}

.status {
margin-top: 20px;
padding: 15px;
border-radius: 8px;
display: none;
}

.status.success {
background: #d4edda;
color: #155724;
border: 1px solid #c3e6cb;
}

.status.error {
background: #f8d7da;
color: #721c24;
border: 1px solid #f5c6cb;
}

.status.loading {
background: #d1ecf1;
color: #0c5460;
border: 1px solid #bee5eb;
}

.status a {
color: inherit;
font-weight: 600;
}

.hidden {
display: none !important;
}

/* Template badge styling */
.template-badge {
display: inline-block;
padding: 4px 12px;
border-radius: 12px;
font-size: 12px;
font-weight: 600;
margin-left: 8px;
}

.template-badge.multi {
background: #e3f2fd;
color: #1976d2;
}

.template-badge.spotlight {
background: #fff3e0;
color: #e65100;
}

/* Script Editor Styles */
.script-editor {
background: #f8f9ff;
border: 2px solid #667eea;
border-radius: 12px;
padding: 24px;
margin-top: 20px;
}

.script-editor h2 {
color: #333;
font-size: 20px;
margin-bottom: 16px;
display: flex;
align-items: center;
gap: 8px;
}

.script-section {
margin-bottom: 20px;
}

.script-section label {
font-size: 13px;
text-transform: uppercase;
letter-spacing: 0.5px;
color: #667eea;
margin-bottom: 8px;
}

.script-section textarea {
width: 100%;
padding: 12px;
border: 2px solid #e0e0e0;
border-radius: 8px;
font-size: 15px;
font-family: inherit;
line-height: 1.5;
resize: vertical;
transition: border-color 0.3s, background-color 0.3s;
}

.script-section textarea:focus {
outline: none;
border-color: #667eea;
}

.script-section textarea:disabled {
background-color: #f5f5f5;
color: #666;
cursor: not-allowed;
}

.script-section textarea.hook {
min-height: 60px;
}

.script-section textarea.body {
min-height: 200px;
}

.script-section textarea.cta {
min-height: 80px;
}

.script-meta {
display: flex;
gap: 16px;
margin-bottom: 16px;
flex-wrap: wrap;
}

.script-meta-item {
background: white;
padding: 8px 14px;
border-radius: 20px;
font-size: 13px;
color: #666;
border: 1px solid #e0e0e0;
}

.script-meta-item strong {
color: #333;
}

.script-actions {
display: flex;
gap: 12px;
margin-top: 20px;
}

.script-actions button {
flex: 1;
padding: 14px;
border-radius: 8px;
font-size: 15px;
font-weight: 600;
cursor: pointer;
transition: all 0.2s;
}

.script-actions button:disabled {
opacity: 0.5;
cursor: not-allowed;
}

.btn-regenerate {
background: white;
color: #667eea;
border: 2px solid #667eea;
}

.btn-regenerate:hover:not(:disabled) {
background: #f8f9ff;
}

.btn-approve {
background: linear-gradient(135deg, #10b981 0%, #059669 100%);
color: white;
border: none;
}

.btn-approve:hover:not(:disabled) {
transform: translateY(-1px);
box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.btn-back {
background: #f0f0f0;
color: #666;
border: none;
}

.btn-back:hover:not(:disabled) {
background: #e0e0e0;
}

.word-count {
font-size: 12px;
color: #999;
text-align: right;
margin-top: 4px;
}

/* Timing estimate */
.timing-estimate {
background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
border-radius: 8px;
padding: 12px 16px;
margin-top: 16px;
display: flex;
align-items: center;
gap: 8px;
}

.timing-estimate .icon {
font-size: 20px;
}

.timing-estimate .text {
font-size: 14px;
color: #333;
}

.timing-estimate .duration {
font-weight: 600;
color: #667eea;
}
</style>
</head>
<body>
<div class="container">
<h1>üé¨ Ad Pilot Video Generator</h1>
<p class="subtitle">Drive Business, Boost Social Presence <span style="color: #999; font-size: 12px;">v2.4</span> | <a href="guidance.html" target="_blank" style="color: #667eea; text-decoration: none;">üìù Guidance Rules</a></p>

<!-- FORM VIEW -->
<form id="adForm">
    <!-- Client Selection -->
    <div class="form-group">
        <label for="client">
            Client
            <span class="label-description">Select the client</span>
        </label>
        <select id="client" name="client" required onchange="handleClientChange()">
            <option value="">Select client...</option>
            <option value="ccc" data-client-id="a1b2c3d4-e5f6-7890-abcd-ef1234567890">Capitol Car Credit</option>
            <option value="adpilot" disabled>Ad Pilot (coming soon)</option>
        </select>
    </div>

    <!-- Template Selection -->
    <div class="form-group hidden" id="templateGroup">
        <label for="template">
            Template
            <span class="label-description">Choose your video style</span>
        </label>
        <select id="template" name="template" required onchange="handleTemplateChange()">
            <option value="">Select template...</option>
            <optgroup label="Ad Templates (with platform banners)">
                <option value="ad-multi-item-1">üöó Ad - Multi Item (1-5 vehicles)</option>
                <option value="ad-single-item-spotlight-1">‚≠ê Ad - Single Item Spotlight</option>
            </optgroup>
            <optgroup label="Organic Templates (no banners)">
                <option value="organic-educational-1">üí° Organic - Educational</option>
            </optgroup>
        </select>
    </div>

    <!-- Ratio Selection (for Ad templates) -->
    <div class="form-group hidden" id="ratioGroup">
        <label>
            Video Ratios
            <span class="label-description">Select one or more aspect ratios</span>
        </label>
        <div class="checkbox-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;">
            <label class="ratio-checkbox" style="display: flex; align-items: center; padding: 12px; background: #f8f9ff; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                <input type="checkbox" name="ratios" value="9:16" onchange="checkFormValidity()" style="margin-right: 8px;">
                <span><strong>9:16</strong><br><small style="color: #666;">Vertical/Reels</small></span>
            </label>
            <label class="ratio-checkbox" style="display: flex; align-items: center; padding: 12px; background: #f8f9ff; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                <input type="checkbox" name="ratios" value="4:5" onchange="checkFormValidity()" style="margin-right: 8px;">
                <span><strong>4:5</strong><br><small style="color: #666;">IG/FB Feed</small></span>
            </label>
            <label class="ratio-checkbox" style="display: flex; align-items: center; padding: 12px; background: #f8f9ff; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                <input type="checkbox" name="ratios" value="16:9" onchange="checkFormValidity()" style="margin-right: 8px;">
                <span><strong>16:9</strong><br><small style="color: #666;">Landscape/YT</small></span>
            </label>
        </div>
    </div>

    <!-- Platform Selection (for Ad templates - adds banner) -->
    <div class="form-group hidden" id="platformGroup">
        <label>
            Platforms
            <span class="label-description">Select platforms for banner overlay (per ratio selected above)</span>
        </label>
        <div class="checkbox-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
            <label class="platform-checkbox" style="display: flex; align-items: center; padding: 12px; background: #f8f9ff; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                <input type="checkbox" name="platforms" value="YOUTUBE" onchange="checkFormValidity()" style="margin-right: 8px;">
                <span>üì∫ YouTube</span>
            </label>
            <label class="platform-checkbox" style="display: flex; align-items: center; padding: 12px; background: #f8f9ff; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                <input type="checkbox" name="platforms" value="TIKTOK" onchange="checkFormValidity()" style="margin-right: 8px;">
                <span>üéµ TikTok</span>
            </label>
            <label class="platform-checkbox" style="display: flex; align-items: center; padding: 12px; background: #f8f9ff; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                <input type="checkbox" name="platforms" value="FACEBOOK" onchange="checkFormValidity()" style="margin-right: 8px;">
                <span>üìò Facebook</span>
            </label>
            <label class="platform-checkbox" style="display: flex; align-items: center; padding: 12px; background: #f8f9ff; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer;">
                <input type="checkbox" name="platforms" value="INSTAGRAM" onchange="checkFormValidity()" style="margin-right: 8px;">
                <span>üì∑ Instagram</span>
            </label>
        </div>
        <div id="videoCountEstimate" style="margin-top: 12px; padding: 10px; background: #e8f5e9; border-radius: 6px; font-size: 13px; color: #2e7d32; display: none;">
            <strong>üìä Output:</strong> <span id="videoCountText">0 videos</span>
        </div>
    </div>

    <!-- Avatar Selection -->
    <div class="form-group hidden" id="avatarGroup">
        <label>
            Avatar Presenter
            <span class="label-description">Select person, then choose their avatar style</span>
        </label>
        <div style="display: flex; gap: 12px; align-items: flex-start;">
            <div style="flex: 2; display: flex; flex-direction: column; gap: 10px;">
                <select id="avatarPerson" onchange="handleAvatarPersonChange()">
                    <option value="">Select person...</option>
                </select>
                <select id="avatar" name="avatar" required onchange="handleAvatarChange()" disabled>
                    <option value="">Select person first...</option>
                </select>
            </div>
            <div id="avatarPreview" style="display: none; flex: 1; aspect-ratio: 9/16; border-radius: 8px; overflow: hidden; border: 2px solid #e0e0e0;">
                <video id="avatarPreviewVideo" src="" autoplay loop muted playsinline style="width: 100%; height: 100%; object-fit: cover;"></video>
            </div>
        </div>
    </div>

    <!-- Background Selection -->
    <div class="form-group hidden" id="backgroundGroup">
        <label for="background">
            Background
            <span class="label-description">Choose the scene background</span>
        </label>
        <div style="display: flex; gap: 12px; align-items: flex-start;">
            <select id="background" name="background" onchange="handleBackgroundChange()" style="flex: 2;">
                <option value="">Loading backgrounds...</option>
            </select>
            <div id="backgroundPreview" style="display: none; flex: 1; aspect-ratio: 9/16; border-radius: 8px; overflow: hidden; border: 2px solid #e0e0e0;">
                <img id="backgroundPreviewImg" src="" alt="Background preview" style="width: 100%; height: 100%; object-fit: cover;">
            </div>
        </div>
    </div>

    <!-- Music Selection -->
    <div class="form-group hidden" id="musicGroup">
        <label for="music">
            Background Music
            <span class="label-description">Choose background music for your video</span>
        </label>
        <div style="display: flex; gap: 10px; align-items: center;">
            <select id="music" name="music" style="flex: 1;" onchange="handleMusicChange()">
                <option value="">Loading music...</option>
            </select>
            <button type="button" id="previewMusicBtn" onclick="toggleMusicPreview()" style="padding: 10px 16px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; display: none;">
                ‚ñ∂Ô∏è Preview
            </button>
        </div>
    </div>

    <!-- Target Length (show early for temp_003) -->
    <div class="form-group hidden" id="lengthGroup">
        <label for="scriptLength" title="TikTok: 15-30s | Instagram Reels: 20-40s | YouTube Shorts: 30-60s | Facebook Reels: 30-60s" style="cursor: help;">
            Target Length ‚ÑπÔ∏è
            <span class="label-description">How detailed should the script be?</span>
        </label>
        <select id="scriptLength" name="script_length" required onchange="handleLengthChange()">
            <option value="">Select length...</option>
            <option value="quick">Brief (~15-30 sec)</option>
            <option value="standard">Standard (~30-45 sec)</option>
            <option value="detailed">Detailed (~45-60 sec)</option>
        </select>
    </div>

    <!-- Educational Theme Section (only shows after length selected for organic template) -->
    <div class="form-group hidden" id="topicGroup">
        <label>Capitol Smarts Theme
            <span class="label-description">Generate a timely, locally-resonant theme for your educational video</span>
        </label>
        <div style="display: flex; gap: 10px; align-items: center;">
            <input type="text" id="topic" name="topic" placeholder="Enter a local topic or event..." style="flex: 1;">
            <button type="button" id="generateEduThemeBtn" onclick="generateEduTheme()" style="padding: 12px 16px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; white-space: nowrap;" title="Generate new theme">
                üîÑ
            </button>
        </div>
        <p style="font-size: 12px; color: #666; margin-top: 8px;">
            Want us to build the theme around a local topic or event? Type it in the box and press enter!<br>
            Just want us to generate a new theme? Press the regenerate button.
        </p>
        <div id="eduThemePackInfo" style="display: none; margin-top: 10px; padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #667eea;">
            <div style="font-size: 13px; color: #333;">
                <strong id="eduThemePackName"></strong>
                <span id="eduThemePackEmoji" style="margin-left: 4px;"></span>
            </div>
            <div id="eduThemePackAngle" style="font-size: 12px; color: #666; margin-top: 4px;"></div>
        </div>
    </div>


    <div class="form-group hidden" id="themeGroup">
        <label for="theme">
            Theme
            <span class="label-description">Generate a timely, locally-resonant theme for your ad</span>
        </label>
        <div style="display: flex; gap: 10px; align-items: center;">
            <input type="text" id="theme" name="theme" placeholder="Enter a local topic or event..." style="flex: 1;">
            <button type="button" id="generateThemeBtn" onclick="generateTheme()" style="padding: 12px 16px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; white-space: nowrap;" title="Generate new theme">
                üîÑ
            </button>
        </div>
        <p id="themeHelperText" style="font-size: 12px; color: #666; margin-top: 8px;">
            Want us to build the theme around a local topic or event? Type it in the box and press enter!<br>
            Just want us to generate a new theme? Press the regenerate button.
        </p>
        <div id="themePackInfo" style="display: none; margin-top: 10px; padding: 12px; background: #f0f9ff; border-radius: 8px; border-left: 4px solid #667eea;">
            <div style="font-size: 13px; color: #333;">
                <strong id="themePackName"></strong>
                <span id="themePackEmoji" style="margin-left: 4px;"></span>
            </div>
            <div id="themePackTension" style="font-size: 12px; color: #666; margin-top: 4px;"></div>
        </div>
    </div>

    <!-- Include Animation Checkbox (HIDDEN - coming soon!) -->
    <div class="checkbox-group hidden" id="animationGroup" style="display: none !important;">
        <label class="checkbox-label">
            <input type="checkbox" id="includeAnimation" name="include_animation" value="false">
            <span>
                <strong>Include theme animation</strong>
                <div class="label-description">Adds a 2-second animated intro based on your theme</div>
            </span>
        </label>
    </div>

    <!-- Email -->
    <div class="form-group hidden" id="emailGroup">
        <label for="email">
            Email Address
            <span class="label-description">We'll send the finished video here</span>
        </label>
        <input type="email" id="email" name="email" required placeholder="your.email@example.com">
    </div>

    <!-- Vehicles -->
    <div class="form-group hidden" id="vehiclesGroup">
        <label id="vehicleLabel">Vehicles (1-5)</label>
        <div id="vehicleContainer">
            <!-- Vehicle groups added dynamically -->
        </div>
        <button type="button" id="addVehicleBtn" class="add-vehicle" onclick="addVehicle()" disabled>
            + Add Vehicle (max 5)
        </button>
    </div>

    <!-- Action Buttons -->
    <div id="formButtons">
        <div class="button-group">
            <button type="button" id="previewBtn" class="btn-secondary" onclick="previewScript()" disabled>
                üìù Preview Script
            </button>
            <button type="submit" id="submitBtn" class="btn-primary" disabled>
                üöÄ Generate Ad
            </button>
        </div>
    </div>

    <!-- Status Messages -->
    <div id="status" class="status"></div>
    
    <div style="margin-top: 20px;">
        <input type="checkbox" id="testMode" name="test_mode" value="true">
        <label for="testMode" style="display: inline; font-weight: normal;">Test Mode (cache API responses for debugging)</label>
    </div>
    <div style="margin-top: 10px;">
        <input type="checkbox" id="useTestVoice" name="use_test_voice" value="true">
        <label for="useTestVoice" style="display: inline; font-weight: normal;">Use Test Voice (save 11Labs credits during development)</label>
    </div>
</form>

<!-- SCRIPT EDITOR VIEW -->
<div id="scriptEditor" class="script-editor hidden">
    <h2>üìù Review Your Script</h2>
    
    <div class="script-meta">
        <div class="script-meta-item">
            <strong>Template:</strong> <span id="metaTemplate">-</span>
        </div>
        <div class="script-meta-item">
            <strong>Length:</strong> <span id="metaLength">-</span>
        </div>
        <div class="script-meta-item">
            <strong>Presenter:</strong> <span id="metaPresenter">-</span>
        </div>
    </div>
    
    <div class="script-section">
        <label for="editHook">HOOK (OPENING)</label>
        <textarea id="editHook" class="hook" placeholder="Your attention-grabbing opening line..."></textarea>
        <div class="word-count"><span id="hookWordCount">0 words</span></div>
    </div>
    
    <div class="script-section">
        <label for="editBody">BODY (MAIN CONTENT)</label>
        <textarea id="editBody" class="body" placeholder="Main content of your video..."></textarea>
        <div class="word-count"><span id="bodyWordCount">0 words</span></div>
    </div>
    
    <div class="script-section">
        <label for="editCta">CALL TO ACTION (CLOSING)</label>
        <textarea id="editCta" class="cta" placeholder="Your closing call to action..."></textarea>
        <div class="word-count"><span id="ctaWordCount">0 words</span></div>
    </div>
    
    <div class="timing-estimate">
        <span class="icon">‚è±Ô∏è</span>
        <span class="text">Estimated duration: <span class="duration" id="estimatedDuration">~0 seconds</span></span>
    </div>

    <div class="guidance-hint" style="text-align: right; margin: 12px 0 8px 0;">
        <a href="guidance.html" target="_blank" style="color: #666; font-size: 13px; text-decoration: none;">
            üìù See something wrong? <span style="text-decoration: underline;">Add a guidance rule</span> so we remember next time ‚Üí
        </a>
    </div>

    <div class="script-actions">
        <button type="button" class="btn-back" onclick="backToForm()">‚Üê Back</button>
        <button type="button" class="btn-regenerate" onclick="regenerateScript()">üîÑ Regenerate</button>
        <button type="button" class="btn-approve" onclick="approveAndGenerate()">‚úÖ Approve & Generate Video</button>
    </div>
    
    <div id="editorStatus" class="status"></div>
</div>
</div>

<script>
// =====================
// CONFIGURATION
// =====================
const WEBHOOK_URL = 'https://ad-pilot-n8n-production.up.railway.app/webhook/ad-pilot';
// CORS proxy needed - n8n Cloud doesn't support preflight OPTIONS requests
const THEMATIC_PACK_URL = 'https://corsproxy.io/?' + encodeURIComponent('https://ad-pilot-n8n-production.up.railway.app/webhook/thematic-pack-generate');
const AVATARS_URL = 'https://ad-pilot-n8n-production.up.railway.app/webhook/avatars';
const BACKGROUNDS_URL = 'https://ad-pilot-n8n-production.up.railway.app/webhook/backgrounds';
const MUSIC_URL = 'https://ad-pilot-n8n-production.up.railway.app/webhook/music';
const INVENTORY_SHEET = 'https://docs.google.com/spreadsheets/d/1kgSVMgpWVSFeAAz4M2LpNmIbuhaJKds9gnbsvLdP-t4/gviz/tq?tqx=out:json&sheet=Feed';

const MAX_CARS = 5;
let vehicleCount = 0;
let inventory = [];
let avatars = [];
let backgrounds = [];
let musicTracks = [];
let currentAudio = null;
let selectedTemplate = '';
let cachedWorkflowConfig = null;
let originalTestMode = false;
let originalUseTestVoice = false;
let currentThemePack = null;  // Store the generated theme pack
let lastGeneratedTheme = '';  // Track what was last generated (to detect user edits)
let lastGeneratedEduTheme = '';  // Track what was last generated for edu template

// Template configuration from database
const TEMPLATE_CONFIG = {
    'organic-educational-1': {
        code: 'EDUCATIONAL-1',
        has_background: true,
        has_music: false,
        bg_categories: ['interior'],
        bg_wide_override: null,
        available_ratios: ['9:16']
    },
    'ad-multi-item-1': {
        code: 'MULTI-ITEM-1',
        has_background: true,
        has_music: true,
        bg_categories: ['exterior', 'themed'],
        bg_wide_override: null,
        available_ratios: ['9:16', '4:5', '16:9']
    },
    'ad-single-item-spotlight-1': {
        code: 'SINGLE-ITEM-SPOTLIGHT-1',
        has_background: true,
        has_music: true,
        bg_categories: [],  // Empty = hide selector, workflow uses default
        bg_wide_override: 'interior',
        available_ratios: ['9:16', '4:5', '16:9']
    }
};

// =====================
// TEMPLATE HANDLING
// =====================
function handleClientChange() {
    const client = document.getElementById('client').value;
    const templateGroup = document.getElementById('templateGroup');
    
    if (client) {
        templateGroup.classList.remove('hidden');
    } else {
        templateGroup.classList.add('hidden');
        // Reset template and hide all dependent fields
        document.getElementById('template').value = '';
        handleTemplateChange();
    }
    
    checkFormValidity();
}

function handleTemplateChange() {
    selectedTemplate = document.getElementById('template').value;
    const templateConfig = TEMPLATE_CONFIG[selectedTemplate] || null;

    const ratioGroup = document.getElementById('ratioGroup');
    const platformGroup = document.getElementById('platformGroup');
    const avatarGroup = document.getElementById('avatarGroup');
    const backgroundGroup = document.getElementById('backgroundGroup');
    const musicGroup = document.getElementById('musicGroup');
    const lengthGroup = document.getElementById('lengthGroup');
    const vehiclesGroup = document.getElementById('vehiclesGroup');
    const topicGroup = document.getElementById('topicGroup');
    const themeGroup = document.getElementById('themeGroup');
    const emailGroup = document.getElementById('emailGroup');
    const addVehicleBtn = document.getElementById('addVehicleBtn');

    // Reset visibility
    ratioGroup.classList.add('hidden');
    platformGroup.classList.add('hidden');
    avatarGroup.classList.add('hidden');
    backgroundGroup.classList.add('hidden');
    musicGroup.classList.add('hidden');
    lengthGroup.classList.add('hidden');
    vehiclesGroup.classList.add('hidden');
    topicGroup.classList.add('hidden');
    themeGroup.classList.add('hidden');
    emailGroup.classList.add('hidden');

    // Stop any playing audio preview and reset music selection
    if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
        updateMusicPreviewButton(false);
    }
    document.getElementById('music').value = '';
    document.getElementById('previewMusicBtn').style.display = 'none';

    // Hide background preview and reset
    document.getElementById('backgroundPreview').style.display = 'none';
    document.getElementById('backgroundPreviewImg').src = '';
    document.getElementById('background').value = '';

    // Hide avatar preview and reset dropdowns
    document.getElementById('avatarPreview').style.display = 'none';
    document.getElementById('avatarPreviewVideo').src = '';
    document.getElementById('avatarPerson').value = '';
    document.getElementById('avatar').value = '';
    document.getElementById('avatar').disabled = true;
    document.getElementById('avatar').innerHTML = '<option value="">Select person first...</option>';

    // Reset checkboxes
    document.querySelectorAll('input[name="ratios"]').forEach(cb => cb.checked = false);
    document.querySelectorAll('input[name="platforms"]').forEach(cb => cb.checked = false);

    // Reset theme pack (both ad and edu)
    document.getElementById('theme').value = '';
    document.getElementById('themePackInfo').style.display = 'none';
    document.getElementById('topic').value = '';
    document.getElementById('eduThemePackInfo').style.display = 'none';
    currentThemePack = null;
    lastGeneratedTheme = '';
    lastGeneratedEduTheme = '';

    if (!selectedTemplate || !templateConfig) {
        checkFormValidity();
        return;
    }

    // Show common fields for all templates
    avatarGroup.classList.remove('hidden');
    lengthGroup.classList.remove('hidden');
    emailGroup.classList.remove('hidden');

    // Show/hide background based on bg_categories (empty = hide, workflow handles default)
    if (templateConfig.bg_categories && templateConfig.bg_categories.length > 0) {
        backgroundGroup.classList.remove('hidden');
        filterBackgroundsByTemplate(templateConfig.bg_categories);
    }

    // Show/hide music based on has_music
    if (templateConfig.has_music) {
        musicGroup.classList.remove('hidden');
    }

    // Filter available ratios
    updateAvailableRatios(templateConfig.available_ratios);

    // Check if it's an AD template or ORGANIC template
    const isAdTemplate = selectedTemplate.startsWith('ad-');
    const isOrganicTemplate = selectedTemplate.startsWith('organic-');

    if (isAdTemplate) {
        // AD templates: show ratio and platform selection
        ratioGroup.classList.remove('hidden');
        platformGroup.classList.remove('hidden');
        vehiclesGroup.classList.remove('hidden');
        themeGroup.classList.remove('hidden');

        if (selectedTemplate === 'ad-multi-item-1') {
            document.getElementById('vehicleLabel').textContent = 'Vehicles (1-5)';
            addVehicleBtn.style.display = 'block';
            addVehicleBtn.disabled = vehicleCount >= MAX_CARS;
        } else if (selectedTemplate === 'ad-single-item-spotlight-1') {
            document.getElementById('vehicleLabel').textContent = 'Vehicle (single spotlight)';
            addVehicleBtn.style.display = 'none';

            // Reset to 1 vehicle for single item spotlight
            while (vehicleCount > 1) {
                removeVehicle(vehicleCount);
            }
        }
    } else if (isOrganicTemplate) {
        // ORGANIC templates: only 9:16, no platform banners
        // Auto-select 9:16 ratio (hidden from user)
        // Show topic group only after length is selected
        const scriptLength = document.getElementById('scriptLength').value;
        const avatar = document.getElementById('avatar').value;
        if (scriptLength && avatar) {
            topicGroup.classList.remove('hidden');
        }
    }

    checkFormValidity();
    updateVideoCountEstimate();
}

// Filter backgrounds dropdown based on template's allowed categories
function filterBackgroundsByTemplate(allowedCategories) {
    const select = document.getElementById('background');
    select.innerHTML = '<option value="">Select background...</option>';

    if (!backgrounds.length || !allowedCategories.length) return;

    // Group backgrounds by category, but only include allowed categories
    const categories = {};
    allowedCategories.forEach(cat => categories[cat] = []);

    backgrounds.forEach(bg => {
        const cat = bg.category || 'exterior';
        if (categories[cat]) {
            categories[cat].push(bg);
        }
    });

    // Add options by category
    Object.entries(categories).forEach(([category, bgs]) => {
        if (bgs.length > 0) {
            const optgroup = document.createElement('optgroup');
            optgroup.label = category.charAt(0).toUpperCase() + category.slice(1);
            bgs.forEach(bg => {
                const option = document.createElement('option');
                option.value = bg.id;
                option.textContent = bg.label || bg.name;
                option.dataset.url = bg.cloudinary_url;
                option.dataset.category = category;
                optgroup.appendChild(option);
            });
            select.appendChild(optgroup);
        }
    });
}

// Update ratio checkboxes based on template's available ratios
function updateAvailableRatios(availableRatios) {
    const ratioCheckboxes = document.querySelectorAll('input[name="ratios"]');

    ratioCheckboxes.forEach(checkbox => {
        const ratioLabel = checkbox.closest('label');
        if (availableRatios.includes(checkbox.value)) {
            ratioLabel.style.display = 'flex';
            checkbox.disabled = false;
        } else {
            ratioLabel.style.display = 'none';
            checkbox.disabled = true;
            checkbox.checked = false;
        }
    });
}

function updateVideoCountEstimate() {
    const selectedTemplate = document.getElementById('template').value;
    const isAdTemplate = selectedTemplate.startsWith('ad-');

    if (!isAdTemplate) {
        document.getElementById('videoCountEstimate').style.display = 'none';
        return;
    }

    const ratios = Array.from(document.querySelectorAll('input[name="ratios"]:checked')).map(cb => cb.value);
    const platforms = Array.from(document.querySelectorAll('input[name="platforms"]:checked')).map(cb => cb.value);

    const videoCount = ratios.length * platforms.length;
    const estimateDiv = document.getElementById('videoCountEstimate');
    const countText = document.getElementById('videoCountText');

    if (ratios.length > 0 && platforms.length > 0) {
        countText.textContent = `${videoCount} video${videoCount > 1 ? 's' : ''} (${ratios.length} ratio${ratios.length > 1 ? 's' : ''} √ó ${platforms.length} platform${platforms.length > 1 ? 's' : ''})`;
        estimateDiv.style.display = 'block';
    } else {
        estimateDiv.style.display = 'none';
    }
}

// =====================
// PREVIEW & EDITOR FUNCTIONS
// =====================
async function previewScript() {
    const payload = buildPayload();
    if (!payload) return;
    
    // Save test_mode and use_test_voice settings before we hide the form
    originalTestMode = document.getElementById('testMode').checked;
    originalUseTestVoice = document.getElementById('useTestVoice').checked;

    // Add preview_mode flag
    payload.preview_mode = true;
    
    console.log('Previewing script with payload:', payload);
    
    showStatus('Generating script preview... ‚úçÔ∏è', 'loading');
    document.getElementById('previewBtn').disabled = true;
    document.getElementById('submitBtn').disabled = true;
    
    try {
        // Step 1: Start the job
        const startResponse = await fetch(WEBHOOK_URL + '/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        const startResult = await startResponse.json();
        console.log('Job started:', startResult);
        
        if (!startResponse.ok || !startResult.job_id) {
            throw new Error(startResult.message || 'Failed to start job');
        }
        
        // Step 2: Poll for completion
        const jobId = startResult.job_id;
        let attempts = 0;
        const maxAttempts = 40; // 2 minutes max (40 * 3 seconds)
        
        while (attempts < maxAttempts) {
            await new Promise(resolve => setTimeout(resolve, 3000)); // Wait 3 seconds
            
            const statusResponse = await fetch(WEBHOOK_URL + '/status?job_id=' + jobId);
            const statusResult = await statusResponse.json();
            console.log('Job status:', statusResult);
            
            if (statusResult.status === 'script_ready') {
            // Look up avatar name from loaded avatars
            const selectedAvatar = avatars.find(a => a.avatar_id === payload.avatar_id);
            const avatarName = selectedAvatar ? selectedAvatar.display_name : '';

            // Build the config object UI expects
            cachedWorkflowConfig = {
                ...payload,
                avatar_name: avatarName,  // Add for UI display
                script: statusResult.script_data,
                // Capture cached API responses for test mode
                api_claude_script_generation: statusResult.api_claude_script_generation,
                api_claude_categorize_photos: statusResult.api_claude_categorize_photos,
                api_claude_feature_identification: statusResult.api_claude_feature_identification
            };
                
                // Populate the editor
                populateScriptEditor(cachedWorkflowConfig);
                
                // Switch views
                document.getElementById('adForm').classList.add('hidden');
                document.getElementById('scriptEditor').classList.remove('hidden');
                hideStatus();
                return;
            } else if (statusResult.status === 'failed') {
                throw new Error(statusResult.error_message || 'Job failed');
            }
            
            // Update status message with elapsed time
            const elapsed = (attempts + 1) * 3;
            showStatus(`Generating script preview... ‚úçÔ∏è (${elapsed}s)`, 'loading');
            attempts++;
        }
        
        throw new Error('Timeout waiting for script generation');
        
    } catch (error) {
        console.error('Preview error:', error);
        showStatus(`Error: ${error.message}`, 'error');
    } finally {
        document.getElementById('previewBtn').disabled = false;
        document.getElementById('submitBtn').disabled = false;
    }
}

function populateScriptEditor(config) {
    const script = config.script || {};
    
    // Set meta info
    document.getElementById('metaTemplate').textContent = config.template_id || '-';
    document.getElementById('metaLength').textContent = config.script_length || '-';
    document.getElementById('metaPresenter').textContent = config.avatar_name || '-';
    
    // Set script content
    document.getElementById('editHook').value = script.hook || '';
    
    // Body could be segments array or full_script minus hook/cta
    let bodyText = '';
    if (script.segments && Array.isArray(script.segments)) {
        bodyText = script.segments.join('\n\n');
    } else if (script.body) {
        bodyText = script.body;
    } else if (script.full_script) {
        // Extract body from full script (remove hook and cta)
        bodyText = script.full_script
            .replace(script.hook || '', '')
            .replace(script.cta || '', '')
            .trim();
    }
    document.getElementById('editBody').value = bodyText;
    
    document.getElementById('editCta').value = script.cta || '';
    
    // Update word counts
    updateWordCounts();
    updateDurationEstimate();
}

function updateWordCounts() {
    const hook = document.getElementById('editHook').value;
    const body = document.getElementById('editBody').value;
    const cta = document.getElementById('editCta').value;
    
    document.getElementById('hookWordCount').textContent = countWords(hook) + ' words';
    document.getElementById('bodyWordCount').textContent = countWords(body) + ' words';
    document.getElementById('ctaWordCount').textContent = countWords(cta) + ' words';
}

function countWords(text) {
    return text.trim().split(/\s+/).filter(w => w.length > 0).length;
}

function updateDurationEstimate() {
    const hook = document.getElementById('editHook').value;
    const body = document.getElementById('editBody').value;
    const cta = document.getElementById('editCta').value;
    
    const totalWords = countWords(hook) + countWords(body) + countWords(cta);
    // Average speaking rate: ~150 words per minute = 2.5 words per second
    const seconds = Math.round(totalWords / 2.5);
    
    document.getElementById('estimatedDuration').textContent = `~${seconds} seconds`;
}

function backToForm() {
    document.getElementById('scriptEditor').classList.add('hidden');
    document.getElementById('adForm').classList.remove('hidden');
    hideStatus();
}

function resetForm() {
    cachedWorkflowConfig = null;
    currentThemePack = null;
    lastGeneratedTheme = '';
    lastGeneratedEduTheme = '';
    lockEditor(false);
    backToForm();
    document.getElementById('adForm').reset();
    document.getElementById('themePackInfo').style.display = 'none';
    document.getElementById('eduThemePackInfo').style.display = 'none';
    handleTemplateChange();
}

function lockEditor(locked) {
    // Lock/unlock textareas
    document.getElementById('editHook').disabled = locked;
    document.getElementById('editBody').disabled = locked;
    document.getElementById('editCta').disabled = locked;
    
    // Lock/unlock buttons
    document.querySelectorAll('.script-actions button').forEach(btn => btn.disabled = locked);
}

async function regenerateScript() {
    showEditorStatus('Regenerating script... ‚úçÔ∏è', 'loading');
    
    // Lock the editor
    lockEditor(true);
    
    try {
        // Re-send original form data with preview_mode
        const payload = buildPayload();
        payload.preview_mode = true;
        
        // Step 1: Start the job
        const startResponse = await fetch(WEBHOOK_URL + '/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        const startResult = await startResponse.json();
        console.log('Regenerate job started:', startResult);
        
        if (!startResponse.ok || !startResult.job_id) {
            throw new Error(startResult.message || 'Failed to start job');
        }
        
        // Step 2: Poll for completion
        const jobId = startResult.job_id;
        let attempts = 0;
        const maxAttempts = 40; // 2 minutes max
        
        while (attempts < maxAttempts) {
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            const statusResponse = await fetch(WEBHOOK_URL + '/status?job_id=' + jobId);
            const statusResult = await statusResponse.json();
            console.log('Regenerate status:', statusResult);
            
            if (statusResult.status === 'script_ready') {
                // Look up avatar name from loaded avatars
                const selectedAvatar = avatars.find(a => a.avatar_id === payload.avatar_id);
                const avatarName = selectedAvatar ? selectedAvatar.display_name : '';

                cachedWorkflowConfig = {
                    ...payload,
                    avatar_name: avatarName,  // Add for UI display
                    script: statusResult.script_data,
                    api_claude_script_generation: statusResult.api_claude_script_generation,
                    api_claude_categorize_photos: statusResult.api_claude_categorize_photos,
                    api_claude_feature_identification: statusResult.api_claude_feature_identification
                };
                populateScriptEditor(cachedWorkflowConfig);
                showEditorStatus('Script regenerated! ‚ú®', 'success');
                return;
            } else if (statusResult.status === 'failed') {
                throw new Error(statusResult.error_message || 'Job failed');
            }
            
            const elapsed = (attempts + 1) * 3;
            showEditorStatus(`Regenerating script... ‚úçÔ∏è (${elapsed}s)`, 'loading');
            attempts++;
        }
        
        throw new Error('Timeout waiting for script generation');
        
    } catch (error) {
        console.error('Regenerate error:', error);
        showEditorStatus(`Error: ${error.message}`, 'error');
    } finally {
        lockEditor(false);
    }
}

async function approveAndGenerate() {
    if (!cachedWorkflowConfig) {
        showEditorStatus('No cached config found. Please regenerate the script.', 'error');
        return;
    }
    
    // Lock the editor immediately
    lockEditor(true);
    
    // Get the edited script values
    const editedHook = document.getElementById('editHook').value.trim();
    const editedBody = document.getElementById('editBody').value.trim();
    const editedCta = document.getElementById('editCta').value.trim();
    
    // Update the cached config with edited script
    const cleanText = (text) => text.replace(/\n+/g, ' ').replace(/\s+/g, ' ').trim();
    
    cachedWorkflowConfig.script = {
        ...cachedWorkflowConfig.script,
        hook: cleanText(editedHook),
        body: cleanText(editedBody),
        cta: cleanText(editedCta),
        segments: editedBody.split(/\n\n+/).map(s => cleanText(s)).filter(s => s),
        full_script: cleanText([editedHook, editedBody, editedCta].filter(s => s).join(' '))
    };
    
    cachedWorkflowConfig.script_edited = true;
    delete cachedWorkflowConfig.preview_mode;
    cachedWorkflowConfig.test_mode = originalTestMode;
    cachedWorkflowConfig.use_test_voice = originalUseTestVoice;

    // Clear old API caches
    delete cachedWorkflowConfig.api_elevenlabs_tts;
    delete cachedWorkflowConfig.api_elevenlabs_forced_alignment;
    delete cachedWorkflowConfig.api_heygen_tts;
    delete cachedWorkflowConfig.audio_url;
    delete cachedWorkflowConfig.api_cloudinary_upload;
    
    console.log('Submitting approved config:', cachedWorkflowConfig);
    
    showEditorStatus('Starting video generation... ‚è±Ô∏è', 'loading');
    
    try {
        // Step 1: Start the job
        const startResponse = await fetch(WEBHOOK_URL + '/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(cachedWorkflowConfig)
        });
        
        const startResult = await startResponse.json();
        console.log('Video job started:', startResult);
        
        if (!startResponse.ok || !startResult.job_id) {
            throw new Error(startResult.message || 'Failed to start video job');
        }
        
        // Step 2: Poll for completion
        const jobId = startResult.job_id;
        let attempts = 0;
        const maxAttempts = 45; // 15 minutes max (45 * 20 seconds)
        
        while (attempts < maxAttempts) {
            await new Promise(resolve => setTimeout(resolve, 20000)); // Wait 20 seconds
            
            const statusResponse = await fetch(WEBHOOK_URL + '/status?job_id=' + jobId);
            const statusResult = await statusResponse.json();
            console.log('Video job status:', statusResult);
            
            if (statusResult.status === 'complete') {
                // Show success with video link and reset button
                let successHtml = 'üéâ Your video is ready!';
                if (statusResult.video_url) {
                    successHtml += ` <a href="${statusResult.video_url}" target="_blank">Click here to view</a>`;
                } else {
                    successHtml += ' Check your email!';
                }
                successHtml += '<br><br><button onclick="resetForm()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Create Another Video</button>';
                showEditorStatus(successHtml, 'success');
                
                // Keep editor locked but don't auto-reset
                return;
            } else if (statusResult.status === 'failed') {
                throw new Error(statusResult.error_message || 'Video generation failed');
            }
            
            // Show generic progress message with elapsed time
            const elapsed = Math.round((attempts + 1) * 20 / 60);
            showEditorStatus(`Generating video... This may take a few minutes ‚è≥ (~${elapsed} min)`, 'loading');
            attempts++;
        }
        
        throw new Error('Timeout waiting for video generation');
        
    } catch (error) {
        console.error('Generation error:', error);
        showEditorStatus(`Error: ${error.message}`, 'error');
        lockEditor(false); // Unlock on error so user can try again
    }
}

function showEditorStatus(message, type) {
    const statusDiv = document.getElementById('editorStatus');
    statusDiv.innerHTML = message; // Use innerHTML to support links
    statusDiv.className = `status ${type}`;
    statusDiv.style.display = 'block';
}

// Add event listeners for word count updates
document.getElementById('editHook').addEventListener('input', () => { updateWordCounts(); updateDurationEstimate(); });
document.getElementById('editBody').addEventListener('input', () => { updateWordCounts(); updateDurationEstimate(); });
document.getElementById('editCta').addEventListener('input', () => { updateWordCounts(); updateDurationEstimate(); });

// =====================
// ORIGINAL FORM FUNCTIONS
// =====================

function buildPayload() {
    const formData = new FormData(document.getElementById('adForm'));
    const client = formData.get('client');
    const clientSelect = document.getElementById('client');
    const clientId = clientSelect.options[clientSelect.selectedIndex]?.dataset?.clientId || null;
    const template = formData.get('template');
    const templateConfig = TEMPLATE_CONFIG[template] || null;
    const topic = formData.get('topic');
    const theme = formData.get('theme') || '';
    const includeAnimation = formData.get('include_animation') === 'true';
    const avatarValue = formData.get('avatar');
    const backgroundId = formData.get('background') || null;  // May be null for spotlight
    const email = formData.get('email');
    const scriptLength = formData.get('script_length');
    const testMode = document.getElementById('testMode').checked;
    const useTestVoice = document.getElementById('useTestVoice').checked;

    // Check if AD or ORGANIC template
    const isAdTemplate = template.startsWith('ad-');
    const isOrganicTemplate = template.startsWith('organic-');

    // Get selected ratios and platforms (for AD templates)
    let ratios = [];
    let platforms = [];

    if (isAdTemplate) {
        ratios = Array.from(document.querySelectorAll('input[name="ratios"]:checked')).map(cb => cb.value);
        platforms = Array.from(document.querySelectorAll('input[name="platforms"]:checked')).map(cb => cb.value);
    } else if (isOrganicTemplate) {
        // Organic templates: only 9:16, no platforms (no banner)
        ratios = ['9:16'];
        platforms = [];
    }

    // Avatar ID - workflow looks up voice_id and name from database
    const avatar_id = avatarValue;

    const vins = [];
    for (let i = 1; i <= vehicleCount; i++) {
        const vin = formData.get(`vehicle${i}`);
        if (vin) vins.push(vin);
    }

    // Validate vehicles if NOT organic template
    if (!isOrganicTemplate) {
        if (vins.length === 0) {
            showStatus('Please select at least one vehicle', 'error');
            return null;
        }
    }

    if (template === 'ad-single-item-spotlight-1' && vins.length > 1) {
        showStatus('Single Item Spotlight only supports 1 vehicle', 'error');
        return null;
    }

    // Get background music URL (optional) - only if template has music
    let musicCloudinaryUrl = null;
    if (templateConfig && templateConfig.has_music) {
        const musicSelect = document.getElementById('music');
        const selectedMusicOption = musicSelect.options[musicSelect.selectedIndex];
        musicCloudinaryUrl = selectedMusicOption?.dataset?.cloudinaryUrl || null;
    }

    return {
        client: client,
        client_id: clientId,
        template_id: template,
        ratios: ratios,           // Array of ratios
        platforms: platforms,     // Array of platforms (empty for organic)
        theme: theme,
        theme_pack: currentThemePack,  // Include full theme pack if generated
        topic: topic,
        include_animation: includeAnimation,
        avatar_id: avatar_id,     // Workflow looks up voice_id, voice_settings, and name from database
        background_id: backgroundId,  // Background ID or null (workflow handles default for spotlight)
        media: { music_url: musicCloudinaryUrl },  // Cloudinary full audio URL for video (null if no music)
        script_length: scriptLength,
        email: email,
        vins: vins,
        test_mode: testMode,
        use_test_voice: useTestVoice
    };
}

async function loadInventory() {
    try {
        const response = await fetch(INVENTORY_SHEET);
        const text = await response.text();
        const json = JSON.parse(text.substr(47).slice(0, -2));

        inventory = json.table.rows.slice(1).map(row => {
            const cells = row.c;
            return {
                vin: cells[1]?.v || '',
                make: cells[4]?.v || '',
                model: cells[5]?.v || '',
                year: cells[6]?.v || '',
                price: cells[14]?.v || ''
            };
        }).filter(car => car.vin && car.year && car.make && car.model);

        inventory.sort((a, b) => b.year - a.year);

        console.log(`Loaded ${inventory.length} vehicles from inventory`);

        addVehicle();

    } catch (error) {
        console.error('Error loading inventory:', error);
        showStatus('Error loading vehicle inventory. Please refresh the page.', 'error');
    }
}

async function loadAvatars() {
    try {
        const response = await fetch(AVATARS_URL);
        const data = await response.json();

        if (data.success && data.avatars) {
            avatars = data.avatars;

            // Get unique persons from avatars
            const persons = [];
            const seenPersons = new Set();
            avatars.forEach(avatar => {
                const personKey = avatar.display_name;
                if (!seenPersons.has(personKey)) {
                    seenPersons.add(personKey);
                    persons.push({
                        display_name: avatar.display_name,
                        full_name: avatar.full_name
                    });
                }
            });

            // Populate person dropdown
            const personSelect = document.getElementById('avatarPerson');
            personSelect.innerHTML = '<option value="">Select person...</option>';
            persons.forEach(person => {
                const option = document.createElement('option');
                option.value = person.display_name;
                option.textContent = person.full_name || person.display_name;
                personSelect.appendChild(option);
            });

            // Avatar dropdown starts disabled
            const avatarSelect = document.getElementById('avatar');
            avatarSelect.innerHTML = '<option value="">Select person first...</option>';
            avatarSelect.disabled = true;

            console.log(`Loaded ${avatars.length} avatars for ${persons.length} persons`);
        } else {
            throw new Error('Invalid response from avatars API');
        }
    } catch (error) {
        console.error('Error loading avatars:', error);
        const personSelect = document.getElementById('avatarPerson');
        personSelect.innerHTML = '<option value="">Error loading avatars</option>';
    }
}

function handleAvatarPersonChange() {
    const personSelect = document.getElementById('avatarPerson');
    const avatarSelect = document.getElementById('avatar');
    const selectedPerson = personSelect.value;

    // Hide preview when person changes
    document.getElementById('avatarPreview').style.display = 'none';
    document.getElementById('avatarPreviewVideo').src = '';

    if (!selectedPerson) {
        avatarSelect.innerHTML = '<option value="">Select person first...</option>';
        avatarSelect.disabled = true;
        checkFormValidity();
        return;
    }

    // Filter avatars for selected person
    const personAvatars = avatars.filter(a => a.display_name === selectedPerson);

    avatarSelect.innerHTML = '<option value="">Select avatar style...</option>';
    personAvatars.forEach(avatar => {
        const option = document.createElement('option');
        option.value = avatar.avatar_id;
        // Show style name and motion preset
        let displayText = avatar.style_name || 'Default';
        if (avatar.motion_preset) {
            displayText += ` (${avatar.motion_preset})`;
        }
        option.textContent = displayText;
        option.dataset.previewUrl = avatar.preview_video_url || '';
        avatarSelect.appendChild(option);
    });

    avatarSelect.disabled = false;
    checkFormValidity();
}

function handleAvatarChange() {
    const avatarSelect = document.getElementById('avatar');
    const previewDiv = document.getElementById('avatarPreview');
    const previewVideo = document.getElementById('avatarPreviewVideo');
    const selectedOption = avatarSelect.options[avatarSelect.selectedIndex];

    if (avatarSelect.value && selectedOption.dataset.previewUrl) {
        previewVideo.src = selectedOption.dataset.previewUrl;
        previewDiv.style.display = 'block';
    } else {
        previewDiv.style.display = 'none';
        previewVideo.src = '';
    }

    handleLengthChange(); // Re-check if topic should show for organic templates
    checkFormValidity();
}

async function loadBackgrounds() {
    try {
        const response = await fetch(BACKGROUNDS_URL);
        const data = await response.json();

        if (data.success && data.backgrounds) {
            backgrounds = data.backgrounds;

            // Populate background dropdown
            const select = document.getElementById('background');
            select.innerHTML = '<option value="">Select background...</option>';

            // Group by category
            const categories = { exterior: [], interior: [], themed: [] };
            backgrounds.forEach(bg => {
                const cat = bg.category || 'exterior';
                if (categories[cat]) categories[cat].push(bg);
            });

            // Add options by category
            Object.entries(categories).forEach(([category, bgs]) => {
                if (bgs.length > 0) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = category.charAt(0).toUpperCase() + category.slice(1);
                    bgs.forEach(bg => {
                        const option = document.createElement('option');
                        option.value = bg.id;  // Send ID, workflow looks up URL + crop_data
                        option.textContent = bg.label || bg.name;
                        option.dataset.url = bg.cloudinary_url;  // Keep URL for preview
                        optgroup.appendChild(option);
                    });
                    select.appendChild(optgroup);
                }
            });

            console.log(`Loaded ${backgrounds.length} backgrounds`);
        } else {
            throw new Error('Invalid response from backgrounds API');
        }
    } catch (error) {
        console.error('Error loading backgrounds:', error);
        const select = document.getElementById('background');
        select.innerHTML = '<option value="">Error loading backgrounds</option>';
    }
}

async function loadMusic() {
    try {
        const response = await fetch(MUSIC_URL);
        const data = await response.json();

        if (data.success && data.tracks) {
            musicTracks = data.tracks;

            // Populate music dropdown
            const select = document.getElementById('music');
            select.innerHTML = '<option value="">No music (optional)</option>';

            musicTracks.forEach(track => {
                const option = document.createElement('option');
                option.value = track.audio_url;  // Preview URL for playback
                option.textContent = track.label || track.name;
                option.dataset.songId = track.song_id;
                option.dataset.cloudinaryUrl = track.cloudinary_url || '';  // Full audio URL for video
                select.appendChild(option);
            });

            console.log(`Loaded ${musicTracks.length} music tracks`);
        } else {
            throw new Error('Invalid response from music API');
        }
    } catch (error) {
        console.error('Error loading music:', error);
        const select = document.getElementById('music');
        select.innerHTML = '<option value="">Error loading music</option>';
    }
}

function handleMusicChange() {
    const select = document.getElementById('music');
    const previewBtn = document.getElementById('previewMusicBtn');

    // Stop any currently playing audio
    if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
    }

    // Show/hide preview button
    if (select.value) {
        previewBtn.style.display = 'block';
        updateMusicPreviewButton(false);
    } else {
        previewBtn.style.display = 'none';
    }

    checkFormValidity();
}

function toggleMusicPreview() {
    const select = document.getElementById('music');
    const audioUrl = select.value;

    if (!audioUrl) return;

    if (currentAudio && !currentAudio.paused) {
        // Pause if playing
        currentAudio.pause();
        updateMusicPreviewButton(false);
    } else {
        // Play
        if (!currentAudio || currentAudio.src !== audioUrl) {
            currentAudio = new Audio(audioUrl);
            currentAudio.addEventListener('ended', () => {
                updateMusicPreviewButton(false);
            });
        }
        currentAudio.play();
        updateMusicPreviewButton(true);
    }
}

function updateMusicPreviewButton(isPlaying) {
    const btn = document.getElementById('previewMusicBtn');
    btn.textContent = isPlaying ? '‚è∏Ô∏è Pause' : '‚ñ∂Ô∏è Preview';
}

function handleBackgroundChange() {
    const select = document.getElementById('background');
    const previewDiv = document.getElementById('backgroundPreview');
    const previewImg = document.getElementById('backgroundPreviewImg');
    const selectedOption = select.options[select.selectedIndex];
    const backgroundUrl = selectedOption?.dataset?.url;  // Get URL from data attribute

    if (backgroundUrl) {
        // Show preview with the selected background image
        previewImg.src = backgroundUrl;
        previewDiv.style.display = 'block';
    } else {
        // Hide preview when no background selected
        previewDiv.style.display = 'none';
        previewImg.src = '';
    }

    checkFormValidity();
}

function addVehicle() {
    if (vehicleCount >= MAX_CARS) return;

    vehicleCount++;
    const container = document.getElementById('vehicleContainer');
    const vehicleGroup = document.createElement('div');
    vehicleGroup.className = 'vehicle-group';
    vehicleGroup.dataset.vehicleNum = vehicleCount;

    const select = document.createElement('select');
    select.name = `vehicle${vehicleCount}`;
    // Don't use HTML required - we handle validation in checkFormValidity()
    select.required = false;
    select.onchange = checkFormValidity;

    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'Select vehicle...';
    select.appendChild(defaultOption);

    vehicleGroup.appendChild(select);

    if (vehicleCount > 1) {
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'remove-vehicle';
        removeBtn.textContent = '‚àí';
        removeBtn.onclick = () => removeVehicle(vehicleCount);
        vehicleGroup.appendChild(removeBtn);
    }

    container.appendChild(vehicleGroup);
    populateVehicleDropdowns();
    checkFormValidity();
}

function populateVehicleDropdowns() {
    const selects = document.querySelectorAll('#vehicleContainer select');
    const selectedVins = Array.from(selects).map(s => s.value).filter(v => v);

    selects.forEach(select => {
        const currentValue = select.value;
        select.innerHTML = '<option value="">Select vehicle...</option>';

        inventory.forEach(car => {
            if (!selectedVins.includes(car.vin) || car.vin === currentValue) {
                const option = document.createElement('option');
                option.value = car.vin;
                option.textContent = `${car.year} ${car.make} ${car.model}, ${car.price} - ${car.vin}`;
                select.appendChild(option);
            }
        });

        if (currentValue) {
            select.value = currentValue;
        }
    });

    const addBtn = document.getElementById('addVehicleBtn');
    if (selectedTemplate === 'ad-single-item-spotlight-1') {
        addBtn.disabled = true;
    } else {
        addBtn.disabled = vehicleCount >= MAX_CARS;
    }
}

function removeVehicle(num) {
    if (vehicleCount <= 1) return;

    const vehicleGroup = document.querySelector(`[data-vehicle-num="${num}"]`);
    vehicleGroup.remove();
    vehicleCount--;

    const groups = document.querySelectorAll('.vehicle-group');
    groups.forEach((group, index) => {
        const newNum = index + 1;
        group.dataset.vehicleNum = newNum;
        const select = group.querySelector('select');
        select.name = `vehicle${newNum}`;
        const button = group.querySelector('.remove-vehicle');
        if (button) {
            button.onclick = () => removeVehicle(newNum);
        }
    });

    vehicleCount = groups.length;
    populateVehicleDropdowns();
}

function checkFormValidity() {
    const client = document.getElementById('client').value;
    const template = document.getElementById('template').value;
    const templateConfig = TEMPLATE_CONFIG[template] || null;
    const topic = document.getElementById('topic').value;
    const avatar = document.getElementById('avatar').value;
    const background = document.getElementById('background').value;
    const scriptLength = document.getElementById('scriptLength').value;
    const email = document.getElementById('email').value;
    const selects = document.querySelectorAll('#vehicleContainer select');
    const hasVehicles = Array.from(selects).some(s => s.value);

    // Get selected ratios and platforms
    const ratios = Array.from(document.querySelectorAll('input[name="ratios"]:checked'));
    const platforms = Array.from(document.querySelectorAll('input[name="platforms"]:checked'));

    const submitBtn = document.getElementById('submitBtn');
    const previewBtn = document.getElementById('previewBtn');

    const isAdTemplate = template.startsWith('ad-');
    const isOrganicTemplate = template.startsWith('organic-');

    // Background is only required if template has bg_categories (not empty)
    const backgroundRequired = templateConfig && templateConfig.bg_categories && templateConfig.bg_categories.length > 0;
    const backgroundValid = !backgroundRequired || background;

    let isValid = false;

    if (isOrganicTemplate) {
        // Organic: need topic, no ratios/platforms needed (auto 9:16, no banner)
        isValid = !!(client && template && topic && scriptLength && avatar && backgroundValid && email);
    } else if (isAdTemplate) {
        // Ad templates: need ratios, platforms, and vehicles
        isValid = !!(client && template && ratios.length > 0 && platforms.length > 0 && scriptLength && avatar && backgroundValid && email && hasVehicles);
    }

    submitBtn.disabled = !isValid;
    previewBtn.disabled = !isValid;

    // Update video count estimate
    updateVideoCountEstimate();
}

document.getElementById('adForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const payload = buildPayload();
    if (!payload) return;

    console.log('Submitting payload:', payload);

    showStatus(`Generating your ad... This will take 10 minutes or less. ‚è±Ô∏è`, 'loading');

    document.getElementById('submitBtn').disabled = true;
    document.getElementById('previewBtn').disabled = true;

    try {
        const response = await fetch(WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (response.ok) {
            showStatus(`Success! Your ad is being generated. Check your email in a few minutes. üé¨`, 'success');
            setTimeout(() => {
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('previewBtn').disabled = false;
            }, 5000);
        } else {
            showStatus(`Error: ${result.message || 'Something went wrong'}`, 'error');
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('previewBtn').disabled = false;
        }
    } catch (error) {
        console.error('Submission error:', error);
        showStatus(`Error: ${error.message}`, 'error');
        document.getElementById('submitBtn').disabled = false;
        document.getElementById('previewBtn').disabled = false;
    }
});

function showStatus(message, type) {
    const statusDiv = document.getElementById('status');
    statusDiv.textContent = message;
    statusDiv.className = `status ${type}`;
    statusDiv.style.display = 'block';

    if (type !== 'loading') {
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 5000);
    }
}

function hideStatus() {
    document.getElementById('status').style.display = 'none';
    document.getElementById('editorStatus').style.display = 'none';
}

function handleLengthChange() {
    const template = document.getElementById('template').value;
    const scriptLength = document.getElementById('scriptLength').value;
    const topicGroup = document.getElementById('topicGroup');
    const avatar = document.getElementById('avatar').value;
    const isOrganicTemplate = template.startsWith('organic-');

    if (isOrganicTemplate && scriptLength && avatar) {
        topicGroup.classList.remove('hidden');
    } else if (isOrganicTemplate) {
        topicGroup.classList.add('hidden');
    }

    checkFormValidity();
}

// =====================
// THEME PACK GENERATION
// =====================
async function generateTheme() {
    const themeInput = document.getElementById('theme');
    const generateBtn = document.getElementById('generateThemeBtn');
    const themePackInfo = document.getElementById('themePackInfo');
    const userInput = themeInput.value.trim();

    // Only use input as override if user has changed it from what we last generated
    const userProvidedOverride = userInput && userInput !== lastGeneratedTheme ? userInput : undefined;

    // Show loading state
    generateBtn.disabled = true;
    generateBtn.textContent = '‚è≥';

    try {
        // Add cache buster to prevent CORS proxy caching
        const cacheBuster = `?_=${Date.now()}`;
        const response = await fetch(THEMATIC_PACK_URL + cacheBuster, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                location: 'Rantoul, IL',
                local_event_override: userProvidedOverride
            })
        });

        const data = await response.json();

        if (data.success && data.theme_name) {
            // Store the theme pack
            currentThemePack = data;

            // Update the input with the generated theme name and track it
            themeInput.value = data.theme_name;
            lastGeneratedTheme = data.theme_name;

            // Show the theme pack info
            document.getElementById('themePackName').textContent = data.theme_name;
            document.getElementById('themePackEmoji').textContent = data.emoji || '';
            document.getElementById('themePackTension').textContent = data.core_tension || '';
            themePackInfo.style.display = 'block';

            console.log('Generated theme pack:', data);
        } else {
            console.error('Theme pack generation failed:', data);
            showStatus('Failed to generate theme. Please try again.', 'error');
        }
    } catch (error) {
        console.error('Error generating theme:', error);
        showStatus('Error generating theme. Please try again.', 'error');
    } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = 'üîÑ';
    }
}

// Handle Enter key on theme input
document.getElementById('theme').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        generateTheme();
    }
});

// Handle Enter key on educational topic input
document.getElementById('topic').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        generateEduTheme();
    }
});

// Generate theme for educational template
async function generateEduTheme() {
    const topicInput = document.getElementById('topic');
    const generateBtn = document.getElementById('generateEduThemeBtn');
    const eduThemePackInfo = document.getElementById('eduThemePackInfo');
    const userInput = topicInput.value.trim();

    // Only use input as override if user has changed it from what we last generated
    const userProvidedOverride = userInput && userInput !== lastGeneratedEduTheme ? userInput : undefined;

    // Show loading state
    generateBtn.disabled = true;
    generateBtn.textContent = '‚è≥';

    try {
        // Add cache buster to prevent CORS proxy caching
        const cacheBuster = `?_=${Date.now()}`;
        const response = await fetch(THEMATIC_PACK_URL + cacheBuster, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                location: 'Rantoul, IL',
                local_event_override: userProvidedOverride
            })
        });

        const data = await response.json();

        if (data.success && data.theme_name) {
            // Store the theme pack (reuse same variable)
            currentThemePack = data;

            // Update the input with the generated theme name and track it
            topicInput.value = data.theme_name;
            lastGeneratedEduTheme = data.theme_name;

            // Show the theme pack info
            document.getElementById('eduThemePackName').textContent = data.theme_name;
            document.getElementById('eduThemePackEmoji').textContent = data.emoji || '';
            document.getElementById('eduThemePackAngle').textContent = data.education_angle || '';
            eduThemePackInfo.style.display = 'block';

            console.log('Generated edu theme pack:', data);
            checkFormValidity();
        } else {
            console.error('Edu theme pack generation failed:', data);
            showStatus('Failed to generate theme. Please try again.', 'error');
        }
    } catch (error) {
        console.error('Error generating edu theme:', error);
        showStatus('Error generating theme. Please try again.', 'error');
    } finally {
        generateBtn.disabled = false;
        generateBtn.textContent = 'üîÑ';
    }
}

// Add event listeners for form validation
document.getElementById('client').addEventListener('change', checkFormValidity);
// Avatar change is handled by onchange="handleAvatarChange()" on the element
document.getElementById('email').addEventListener('input', checkFormValidity);
document.getElementById('scriptLength').addEventListener('change', checkFormValidity);
document.getElementById('topic').addEventListener('input', checkFormValidity);

// Initialize on page load
loadInventory();
loadAvatars();
loadBackgrounds();
loadMusic();
</script>
</body>
</html>















