<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ad Pilot - Video Generator</title>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
min-height: 100vh;
padding: 40px 20px;
}

.container {
max-width: 600px;
margin: 0 auto;
background: white;
border-radius: 20px;
padding: 40px;
box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

h1 {
color: #333;
margin-bottom: 10px;
font-size: 32px;
}

.subtitle {
color: #666;
margin-bottom: 30px;
font-size: 16px;
}

.form-group {
margin-bottom: 25px;
}

label {
display: block;
margin-bottom: 8px;
color: #333;
font-weight: 600;
font-size: 14px;
}

.label-description {
font-weight: 400;
color: #666;
font-size: 13px;
margin-top: 4px;
}

input[type="text"],
input[type="email"],
select {
width: 100%;
padding: 12px;
border: 2px solid #e0e0e0;
border-radius: 8px;
font-size: 16px;
transition: border-color 0.3s;
}

input[type="text"]:focus,
input[type="email"]:focus,
select:focus {
outline: none;
border-color: #667eea;
}

/* Checkbox styling */
.checkbox-group {
margin-left: 20px;
padding: 15px;
border-left: 3px solid #667eea;
background: #f8f9ff;
border-radius: 8px;
margin-top: 10px;
}

.checkbox-label {
display: flex;
align-items: center;
cursor: pointer;
}

input[type="checkbox"] {
width: 20px;
height: 20px;
margin-right: 10px;
cursor: pointer;
}

.vehicle-group {
display: flex;
gap: 10px;
margin-bottom: 15px;
align-items: center;
}

.vehicle-group select {
flex: 1;
}

.remove-vehicle {
padding: 12px 16px;
background: #000000;
color: white;
border: none;
border-radius: 8px;
cursor: pointer;
font-size: 18px;
font-weight: 600;
transition: background 0.2s;
}

.remove-vehicle:hover {
background: #333333;
}

.add-vehicle {
width: 100%;
padding: 12px;
background: #f0f0f0;
color: #333;
border: 2px dashed #ccc;
border-radius: 8px;
cursor: pointer;
font-size: 14px;
font-weight: 600;
transition: all 0.2s;
}

.add-vehicle:hover:not(:disabled) {
background: #e0e0e0;
border-color: #999;
}

.add-vehicle:disabled {
opacity: 0.5;
cursor: not-allowed;
}

button[type="submit"],
.btn-primary {
width: 100%;
padding: 16px;
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
color: white;
border: none;
border-radius: 8px;
font-size: 18px;
font-weight: 600;
cursor: pointer;
transition: transform 0.2s;
}

button[type="submit"]:hover,
.btn-primary:hover {
transform: translateY(-2px);
}

button[type="submit"]:active,
.btn-primary:active {
transform: translateY(0);
}

button[type="submit"]:disabled,
.btn-primary:disabled {
opacity: 0.5;
cursor: not-allowed;
transform: none;
}

.btn-secondary {
width: 100%;
padding: 14px;
background: #f0f0f0;
color: #333;
border: 2px solid #ddd;
border-radius: 8px;
font-size: 16px;
font-weight: 600;
cursor: pointer;
transition: all 0.2s;
}

.btn-secondary:hover:not(:disabled) {
background: #e0e0e0;
border-color: #bbb;
}

.btn-secondary:disabled {
opacity: 0.5;
cursor: not-allowed;
}

.button-group {
display: flex;
gap: 12px;
margin-top: 20px;
}

.button-group button {
flex: 1;
}

.status {
margin-top: 20px;
padding: 15px;
border-radius: 8px;
display: none;
}

.status.success {
background: #d4edda;
color: #155724;
border: 1px solid #c3e6cb;
}

.status.error {
background: #f8d7da;
color: #721c24;
border: 1px solid #f5c6cb;
}

.status.loading {
background: #d1ecf1;
color: #0c5460;
border: 1px solid #bee5eb;
}

.status a {
color: inherit;
font-weight: 600;
}

.hidden {
display: none !important;
}

/* Template badge styling */
.template-badge {
display: inline-block;
padding: 4px 12px;
border-radius: 12px;
font-size: 12px;
font-weight: 600;
margin-left: 8px;
}

.template-badge.multi {
background: #e3f2fd;
color: #1976d2;
}

.template-badge.spotlight {
background: #fff3e0;
color: #e65100;
}

/* Script Editor Styles */
.script-editor {
background: #f8f9ff;
border: 2px solid #667eea;
border-radius: 12px;
padding: 24px;
margin-top: 20px;
}

.script-editor h2 {
color: #333;
font-size: 20px;
margin-bottom: 16px;
display: flex;
align-items: center;
gap: 8px;
}

.script-section {
margin-bottom: 20px;
}

.script-section label {
font-size: 13px;
text-transform: uppercase;
letter-spacing: 0.5px;
color: #667eea;
margin-bottom: 8px;
}

.script-section textarea {
width: 100%;
padding: 12px;
border: 2px solid #e0e0e0;
border-radius: 8px;
font-size: 15px;
font-family: inherit;
line-height: 1.5;
resize: vertical;
transition: border-color 0.3s, background-color 0.3s;
}

.script-section textarea:focus {
outline: none;
border-color: #667eea;
}

.script-section textarea:disabled {
background-color: #f5f5f5;
color: #666;
cursor: not-allowed;
}

.script-section textarea.hook {
min-height: 60px;
}

.script-section textarea.body {
min-height: 200px;
}

.script-section textarea.cta {
min-height: 80px;
}

.script-meta {
display: flex;
gap: 16px;
margin-bottom: 16px;
flex-wrap: wrap;
}

.script-meta-item {
background: white;
padding: 8px 14px;
border-radius: 20px;
font-size: 13px;
color: #666;
border: 1px solid #e0e0e0;
}

.script-meta-item strong {
color: #333;
}

.script-actions {
display: flex;
gap: 12px;
margin-top: 20px;
}

.script-actions button {
flex: 1;
padding: 14px;
border-radius: 8px;
font-size: 15px;
font-weight: 600;
cursor: pointer;
transition: all 0.2s;
}

.script-actions button:disabled {
opacity: 0.5;
cursor: not-allowed;
}

.btn-regenerate {
background: white;
color: #667eea;
border: 2px solid #667eea;
}

.btn-regenerate:hover:not(:disabled) {
background: #f8f9ff;
}

.btn-approve {
background: linear-gradient(135deg, #10b981 0%, #059669 100%);
color: white;
border: none;
}

.btn-approve:hover:not(:disabled) {
transform: translateY(-1px);
box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
}

.btn-back {
background: #f0f0f0;
color: #666;
border: none;
}

.btn-back:hover:not(:disabled) {
background: #e0e0e0;
}

.word-count {
font-size: 12px;
color: #999;
text-align: right;
margin-top: 4px;
}

/* Timing estimate */
.timing-estimate {
background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
border-radius: 8px;
padding: 12px 16px;
margin-top: 16px;
display: flex;
align-items: center;
gap: 8px;
}

.timing-estimate .icon {
font-size: 20px;
}

.timing-estimate .text {
font-size: 14px;
color: #333;
}

.timing-estimate .duration {
font-weight: 600;
color: #667eea;
}
</style>
</head>
<body>
<div class="container">
<h1>üé¨ Ad Pilot Video Generator</h1>
<p class="subtitle">Drive Business, Boost Social Presence <span style="color: #999; font-size: 12px;">v1.9</span> | <a href="guidance.html" target="_blank" style="color: #667eea; text-decoration: none;">üìù Guidance Rules</a></p>

<!-- FORM VIEW -->
<form id="adForm">
    <!-- Client Selection -->
    <div class="form-group">
        <label for="client">
            Client
            <span class="label-description">Select the client</span>
        </label>
        <select id="client" name="client" required onchange="handleClientChange()">
            <option value="">Select client...</option>
            <option value="ccc">Capitol Car Credit</option>
            <option value="adpilot" disabled>Ad Pilot (coming soon)</option>
        </select>
    </div>

    <!-- Template Selection -->
    <div class="form-group hidden" id="templateGroup">
        <label for="template">
            Template
            <span class="label-description">Choose your video style</span>
        </label>
        <select id="template" name="template" required onchange="handleTemplateChange()">
            <option value="">Select template...</option>
            <option value="ad-multi-item-1">üöó Ad - Multiple Inventory Item 1 (1-5 items)</option>
            <option value="ad-single-item-spotlight-1">‚≠ê Ad - Single Inventory Item Spotlight 1</option>
            <option value="social-educational-1">üí° Social - Educational 1</option>
        </select>
    </div>

    <!-- Platform Selection -->
    <div class="form-group hidden" id="platformGroup">
        <label for="platform">
            Platform
            <span class="label-description">Where will this video be posted?</span>
        </label>
        <select id="platform" name="platform" required onchange="checkFormValidity()">
            <option value="">Select platform...</option>
            <optgroup label="Vertical (9:16)">
                <option value="tiktok_9:16">TikTok (9:16)</option>
                <option value="youtube-shorts_9:16">YouTube Shorts (9:16)</option>
                <option value="instagram-reels_9:16">Instagram Reels (9:16)</option>
                <option value="facebook-reels_9:16">Facebook Reels (9:16)</option>
            </optgroup>
            <optgroup label="Feed (4:5)">
                <option value="facebook-feed_4:5">Facebook Feed (4:5)</option>
                <option value="instagram-feed_4:5">Instagram Feed (4:5)</option>
            </optgroup>
            <optgroup label="Landscape (16:9)">
                <option value="youtube_16:9">YouTube (16:9)</option>
            </optgroup>
        </select>
    </div>

    <!-- Avatar Selection -->
    <div class="form-group hidden" id="avatarGroup">
        <label for="avatar">
        Avatar Presenter
        </label>
        <select id="avatar" name="avatar" required>
            <option value="">Select avatar...</option>
            <option value="229bfc03d4d24d5ab7a5c71ce4b10d4b|4c673743fdab49cd89ae00a44cb552fb|#89be5a|22|Shad">Shad Delaney</option>
            <option value="5b9c75a2f13e4d60b09bcfdafa7339dd|91cf853f9a91452486ba8ae00a963160|#6da264|8|Kelly">Sexy Kelly</option>
            <option value="f9bb73f75160463ea82fe93f71592fce|f6d15141c0f74f99b855786e6c964b48|#7fc741|29|Gary">Gary Knight</option>
            <option value="ea8afca9ba97405f8b4c7869a879d249|f6d15141c0f74f99b855786e6c964b48|#7fc741|29|Gary">Gary Knight 2</option>
        </select>
    </div>

    <!-- Target Length (show early for temp_003) -->
    <div class="form-group hidden" id="lengthGroup">
        <label for="scriptLength" title="TikTok: 15-30s | Instagram Reels: 20-40s | YouTube Shorts: 30-60s | Facebook Reels: 30-60s" style="cursor: help;">
            Target Length ‚ÑπÔ∏è
            <span class="label-description">How detailed should the script be?</span>
        </label>
        <select id="scriptLength" name="script_length" required onchange="handleLengthChange()">
            <option value="">Select length...</option>
            <option value="quick">Brief (~15-30 sec)</option>
            <option value="standard">Standard (~30-45 sec)</option>
            <option value="detailed">Detailed (~45-60 sec)</option>
        </select>
    </div>

    <!-- Educational Topic Section (only shows after length selected for temp_003) -->
    <div class="form-group hidden" id="topicGroup">
        <label>Capitol Smarts Topic
            <span class="label-description">What should the video be about?</span>
        </label>
        <fieldset style="padding:20px;background-color:#f8f8f8">
            <label for="topic">
                Create your own
                <span class="label-description">Specify a topic.</span>
            </label>
            <input type="text" id="topic" name="topic" placeholder="e.g., What to check before buying a used car">

            <div style="text-align: left; margin: 15px; color: #000; font-weight: 600; font-size: 18px;">OR</div>

            <label>
                Let us help
                <span class="label-description">We make suggestions for you.</span>
            </label>

            <!-- Radio buttons for suggestion mode -->
            <div style="margin-top: 10px; margin-bottom: 15px;">
                <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer; font-weight: 400;">
                    <input type="radio" name="suggestionMode" value="lucky" checked onchange="handleSuggestionModeChange()" style="margin-right: 8px;">
                    <span>I'm feeling lucky</span>
                </label>
                <label style="display: flex; align-items: center; cursor: pointer; font-weight: 400;">
                    <input type="radio" name="suggestionMode" value="guided" onchange="handleSuggestionModeChange()" style="margin-right: 8px;">
                    <span>Give me topics about...</span>
                </label>
            </div>

            <!-- Topic Guidance input (hidden unless "guided" mode selected) -->
            <div id="topicGuidanceContainer" style="display: none; margin-bottom: 15px;">
                <input type="text" id="topicGuidance" name="topic_guidance" oninput="handleGuidanceChange()" placeholder="e.g., winter driving, Thanksgiving travel, financing" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;">
            </div>

            <!-- Suggest Topics Button -->
            <div style="margin-bottom: 15px;">
                <button type="button" id="suggestTopicsBtn" onclick="suggestTopics()" style="padding: 5px 12px 7px 12px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                    üí° Suggest Topics
                </button>
            </div>

            <!-- Suggestions Display -->
            <div id="topicSuggestions" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9ff; border-radius: 8px; border-left: 4px solid #667eea;">
                <div style="font-size: 13px; color: #666; margin-bottom: 10px; font-weight: 600;">Click a suggestion to use it:</div>
                <div id="suggestionsList"></div>
            </div>
        </fieldset>
    </div>


    <div class="form-group hidden" id="themeGroup">
        <label for="theme">
            Theme (Optional)
            <span class="label-description">e.g., Summer Blowout, Back to School, Harvest Deals</span>
        </label>
        <input type="text" id="theme" name="theme" placeholder="Leave blank for generic ad">
    </div>

    <!-- Include Animation Checkbox (HIDDEN - coming soon!) -->
    <div class="checkbox-group hidden" id="animationGroup" style="display: none !important;">
        <label class="checkbox-label">
            <input type="checkbox" id="includeAnimation" name="include_animation" value="false">
            <span>
                <strong>Include theme animation</strong>
                <div class="label-description">Adds a 2-second animated intro based on your theme</div>
            </span>
        </label>
    </div>

    <!-- Email -->
    <div class="form-group hidden" id="emailGroup">
        <label for="email">
            Email Address
            <span class="label-description">We'll send the finished video here</span>
        </label>
        <input type="email" id="email" name="email" required placeholder="your.email@example.com">
    </div>

    <!-- Vehicles -->
    <div class="form-group hidden" id="vehiclesGroup">
        <label id="vehicleLabel">Vehicles (1-5)</label>
        <div id="vehicleContainer">
            <!-- Vehicle groups added dynamically -->
        </div>
        <button type="button" id="addVehicleBtn" class="add-vehicle" onclick="addVehicle()" disabled>
            + Add Vehicle (max 5)
        </button>
    </div>

    <!-- Action Buttons -->
    <div id="formButtons">
        <div class="button-group">
            <button type="button" id="previewBtn" class="btn-secondary" onclick="previewScript()" disabled>
                üìù Preview Script
            </button>
            <button type="submit" id="submitBtn" class="btn-primary" disabled>
                üöÄ Generate Ad
            </button>
        </div>
    </div>

    <!-- Status Messages -->
    <div id="status" class="status"></div>
    
    <div style="margin-top: 20px;">
        <input type="checkbox" id="testMode" name="test_mode" value="true">
        <label for="testMode" style="display: inline; font-weight: normal;">Test Mode (cache API responses for debugging)</label>
    </div>
</form>

<!-- SCRIPT EDITOR VIEW -->
<div id="scriptEditor" class="script-editor hidden">
    <h2>üìù Review Your Script</h2>
    
    <div class="script-meta">
        <div class="script-meta-item">
            <strong>Template:</strong> <span id="metaTemplate">-</span>
        </div>
        <div class="script-meta-item">
            <strong>Length:</strong> <span id="metaLength">-</span>
        </div>
        <div class="script-meta-item">
            <strong>Presenter:</strong> <span id="metaPresenter">-</span>
        </div>
    </div>
    
    <div class="script-section">
        <label for="editHook">HOOK (OPENING)</label>
        <textarea id="editHook" class="hook" placeholder="Your attention-grabbing opening line..."></textarea>
        <div class="word-count"><span id="hookWordCount">0 words</span></div>
    </div>
    
    <div class="script-section">
        <label for="editBody">BODY (MAIN CONTENT)</label>
        <textarea id="editBody" class="body" placeholder="Main content of your video..."></textarea>
        <div class="word-count"><span id="bodyWordCount">0 words</span></div>
    </div>
    
    <div class="script-section">
        <label for="editCta">CALL TO ACTION (CLOSING)</label>
        <textarea id="editCta" class="cta" placeholder="Your closing call to action..."></textarea>
        <div class="word-count"><span id="ctaWordCount">0 words</span></div>
    </div>
    
    <div class="timing-estimate">
        <span class="icon">‚è±Ô∏è</span>
        <span class="text">Estimated duration: <span class="duration" id="estimatedDuration">~0 seconds</span></span>
    </div>

    <div class="guidance-hint" style="text-align: right; margin: 12px 0 8px 0;">
        <a href="guidance.html" target="_blank" style="color: #666; font-size: 13px; text-decoration: none;">
            üìù See something wrong? <span style="text-decoration: underline;">Add a guidance rule</span> so we remember next time ‚Üí
        </a>
    </div>

    <div class="script-actions">
        <button type="button" class="btn-back" onclick="backToForm()">‚Üê Back</button>
        <button type="button" class="btn-regenerate" onclick="regenerateScript()">üîÑ Regenerate</button>
        <button type="button" class="btn-approve" onclick="approveAndGenerate()">‚úÖ Approve & Generate Video</button>
    </div>
    
    <div id="editorStatus" class="status"></div>
</div>
</div>

<script>
// =====================
// CONFIGURATION
// =====================
const WEBHOOK_URL = 'https://ad-pilot-n8n-production.up.railway.app/webhook/ad-pilot';
// CORS proxy needed - n8n Cloud doesn't support preflight OPTIONS requests
const TOPIC_SUGGEST_URL = 'https://corsproxy.io/?' + encodeURIComponent('https://ad-pilot-n8n-production.up.railway.app/webhook/topic-suggest');
const INVENTORY_SHEET = 'https://docs.google.com/spreadsheets/d/1kgSVMgpWVSFeAAz4M2LpNmIbuhaJKds9gnbsvLdP-t4/gviz/tq?tqx=out:json&sheet=Feed';

const MAX_CARS = 5;
let vehicleCount = 0;
let inventory = [];
let selectedTemplate = '';
let cachedWorkflowConfig = null;
let originalTestMode = false;

// =====================
// TEMPLATE HANDLING
// =====================
function handleClientChange() {
    const client = document.getElementById('client').value;
    const templateGroup = document.getElementById('templateGroup');
    
    if (client) {
        templateGroup.classList.remove('hidden');
    } else {
        templateGroup.classList.add('hidden');
        // Reset template and hide all dependent fields
        document.getElementById('template').value = '';
        handleTemplateChange();
    }
    
    checkFormValidity();
}

function handleTemplateChange() {
    selectedTemplate = document.getElementById('template').value;
    const platformGroup = document.getElementById('platformGroup');
    const platformSelect = document.getElementById('platform');
    const avatarGroup = document.getElementById('avatarGroup');
    const lengthGroup = document.getElementById('lengthGroup');
    const vehiclesGroup = document.getElementById('vehiclesGroup');
    const topicGroup = document.getElementById('topicGroup');
    const themeGroup = document.getElementById('themeGroup');
    const emailGroup = document.getElementById('emailGroup');
    const addVehicleBtn = document.getElementById('addVehicleBtn');

    // Reset visibility
    platformGroup.classList.add('hidden');
    avatarGroup.classList.add('hidden');
    lengthGroup.classList.add('hidden');
    vehiclesGroup.classList.add('hidden');
    topicGroup.classList.add('hidden');
    themeGroup.classList.add('hidden');
    emailGroup.classList.add('hidden');

    // Reset platform selection and filter options based on template
    platformSelect.value = '';
    
    // Rebuild platform options based on template
    const allPlatformOptions = `
        <option value="">Select platform...</option>
        <optgroup label="Vertical (9:16)">
            <option value="tiktok_9:16">TikTok (9:16)</option>
            <option value="youtube-shorts_9:16">YouTube Shorts (9:16)</option>
            <option value="instagram-reels_9:16">Instagram Reels (9:16)</option>
            <option value="facebook-reels_9:16">Facebook Reels (9:16)</option>
        </optgroup>
        <optgroup label="Feed (4:5)">
            <option value="facebook-feed_4:5">Facebook Feed (4:5)</option>
            <option value="instagram-feed_4:5">Instagram Feed (4:5)</option>
        </optgroup>
        <optgroup label="Landscape (16:9)">
            <option value="youtube_16:9">YouTube (16:9)</option>
        </optgroup>
    `;
    
    const verticalOnlyOptions = `
        <option value="">Select platform...</option>
        <optgroup label="Vertical (9:16)">
            <option value="tiktok_9:16">TikTok (9:16)</option>
            <option value="youtube-shorts_9:16">YouTube Shorts (9:16)</option>
            <option value="instagram-reels_9:16">Instagram Reels (9:16)</option>
            <option value="facebook-reels_9:16">Facebook Reels (9:16)</option>
        </optgroup>
    `;
    
    if (selectedTemplate === 'social-educational-1') {
        platformSelect.innerHTML = verticalOnlyOptions;
    } else {
        platformSelect.innerHTML = allPlatformOptions;
    }

    if (!selectedTemplate) {
        checkFormValidity();
        return;
    }

    // Show common fields for all templates
    platformGroup.classList.remove('hidden');
    avatarGroup.classList.remove('hidden');
    lengthGroup.classList.remove('hidden');
    emailGroup.classList.remove('hidden');

    if (selectedTemplate === 'ad-multi-item-1') {
        vehiclesGroup.classList.remove('hidden');
        themeGroup.classList.remove('hidden');
        document.getElementById('vehicleLabel').textContent = 'Vehicles (1-5)';
        addVehicleBtn.style.display = 'block';
        addVehicleBtn.disabled = vehicleCount >= MAX_CARS;
    } else if (selectedTemplate === 'ad-single-item-spotlight-1') {
        vehiclesGroup.classList.remove('hidden');
        themeGroup.classList.remove('hidden');
        document.getElementById('vehicleLabel').textContent = 'Vehicle (single spotlight)';
        addVehicleBtn.style.display = 'none';
        
        // Reset to 1 vehicle for single item spotlight
        while (vehicleCount > 1) {
            removeVehicle(vehicleCount);
        }
    } else if (selectedTemplate === 'social-educational-1') {
        // Show topic group only after length is selected
        const scriptLength = document.getElementById('scriptLength').value;
        const avatar = document.getElementById('avatar').value;
        if (scriptLength && avatar) {
            topicGroup.classList.remove('hidden');
        }
    }

    checkFormValidity();
}

// =====================
// PREVIEW & EDITOR FUNCTIONS
// =====================
async function previewScript() {
    const payload = buildPayload();
    if (!payload) return;
    
    // Save test_mode setting before we hide the form
    originalTestMode = document.getElementById('testMode').checked;
    
    // Add preview_mode flag
    payload.preview_mode = true;
    
    console.log('Previewing script with payload:', payload);
    
    showStatus('Generating script preview... ‚úçÔ∏è', 'loading');
    document.getElementById('previewBtn').disabled = true;
    document.getElementById('submitBtn').disabled = true;
    
    try {
        // Step 1: Start the job
        const startResponse = await fetch(WEBHOOK_URL + '/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        const startResult = await startResponse.json();
        console.log('Job started:', startResult);
        
        if (!startResponse.ok || !startResult.job_id) {
            throw new Error(startResult.message || 'Failed to start job');
        }
        
        // Step 2: Poll for completion
        const jobId = startResult.job_id;
        let attempts = 0;
        const maxAttempts = 40; // 2 minutes max (40 * 3 seconds)
        
        while (attempts < maxAttempts) {
            await new Promise(resolve => setTimeout(resolve, 3000)); // Wait 3 seconds
            
            const statusResponse = await fetch(WEBHOOK_URL + '/status?job_id=' + jobId);
            const statusResult = await statusResponse.json();
            console.log('Job status:', statusResult);
            
            if (statusResult.status === 'script_ready') {
            // Build the config object UI expects
            cachedWorkflowConfig = {
                ...payload,
                script: statusResult.script_data,
                // Capture cached API responses for test mode
                api_claude_script_generation: statusResult.api_claude_script_generation,
                api_claude_categorize_photos: statusResult.api_claude_categorize_photos,
                api_claude_feature_identification: statusResult.api_claude_feature_identification
            };
                
                // Populate the editor
                populateScriptEditor(cachedWorkflowConfig);
                
                // Switch views
                document.getElementById('adForm').classList.add('hidden');
                document.getElementById('scriptEditor').classList.remove('hidden');
                hideStatus();
                return;
            } else if (statusResult.status === 'failed') {
                throw new Error(statusResult.error_message || 'Job failed');
            }
            
            // Update status message with elapsed time
            const elapsed = (attempts + 1) * 3;
            showStatus(`Generating script preview... ‚úçÔ∏è (${elapsed}s)`, 'loading');
            attempts++;
        }
        
        throw new Error('Timeout waiting for script generation');
        
    } catch (error) {
        console.error('Preview error:', error);
        showStatus(`Error: ${error.message}`, 'error');
    } finally {
        document.getElementById('previewBtn').disabled = false;
        document.getElementById('submitBtn').disabled = false;
    }
}

function populateScriptEditor(config) {
    const script = config.script || {};
    
    // Set meta info
    document.getElementById('metaTemplate').textContent = config.template_id || '-';
    document.getElementById('metaLength').textContent = config.script_length || '-';
    document.getElementById('metaPresenter').textContent = config.avatar_name || '-';
    
    // Set script content
    document.getElementById('editHook').value = script.hook || '';
    
    // Body could be segments array or full_script minus hook/cta
    let bodyText = '';
    if (script.segments && Array.isArray(script.segments)) {
        bodyText = script.segments.join('\n\n');
    } else if (script.body) {
        bodyText = script.body;
    } else if (script.full_script) {
        // Extract body from full script (remove hook and cta)
        bodyText = script.full_script
            .replace(script.hook || '', '')
            .replace(script.cta || '', '')
            .trim();
    }
    document.getElementById('editBody').value = bodyText;
    
    document.getElementById('editCta').value = script.cta || '';
    
    // Update word counts
    updateWordCounts();
    updateDurationEstimate();
}

function updateWordCounts() {
    const hook = document.getElementById('editHook').value;
    const body = document.getElementById('editBody').value;
    const cta = document.getElementById('editCta').value;
    
    document.getElementById('hookWordCount').textContent = countWords(hook) + ' words';
    document.getElementById('bodyWordCount').textContent = countWords(body) + ' words';
    document.getElementById('ctaWordCount').textContent = countWords(cta) + ' words';
}

function countWords(text) {
    return text.trim().split(/\s+/).filter(w => w.length > 0).length;
}

function updateDurationEstimate() {
    const hook = document.getElementById('editHook').value;
    const body = document.getElementById('editBody').value;
    const cta = document.getElementById('editCta').value;
    
    const totalWords = countWords(hook) + countWords(body) + countWords(cta);
    // Average speaking rate: ~150 words per minute = 2.5 words per second
    const seconds = Math.round(totalWords / 2.5);
    
    document.getElementById('estimatedDuration').textContent = `~${seconds} seconds`;
}

function backToForm() {
    document.getElementById('scriptEditor').classList.add('hidden');
    document.getElementById('adForm').classList.remove('hidden');
    hideStatus();
}

function resetForm() {
    cachedWorkflowConfig = null;
    lockEditor(false);
    backToForm();
    document.getElementById('adForm').reset();
    handleTemplateChange();
}

function lockEditor(locked) {
    // Lock/unlock textareas
    document.getElementById('editHook').disabled = locked;
    document.getElementById('editBody').disabled = locked;
    document.getElementById('editCta').disabled = locked;
    
    // Lock/unlock buttons
    document.querySelectorAll('.script-actions button').forEach(btn => btn.disabled = locked);
}

async function regenerateScript() {
    showEditorStatus('Regenerating script... ‚úçÔ∏è', 'loading');
    
    // Lock the editor
    lockEditor(true);
    
    try {
        // Re-send original form data with preview_mode
        const payload = buildPayload();
        payload.preview_mode = true;
        
        // Step 1: Start the job
        const startResponse = await fetch(WEBHOOK_URL + '/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        const startResult = await startResponse.json();
        console.log('Regenerate job started:', startResult);
        
        if (!startResponse.ok || !startResult.job_id) {
            throw new Error(startResult.message || 'Failed to start job');
        }
        
        // Step 2: Poll for completion
        const jobId = startResult.job_id;
        let attempts = 0;
        const maxAttempts = 40; // 2 minutes max
        
        while (attempts < maxAttempts) {
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            const statusResponse = await fetch(WEBHOOK_URL + '/status?job_id=' + jobId);
            const statusResult = await statusResponse.json();
            console.log('Regenerate status:', statusResult);
            
            if (statusResult.status === 'script_ready') {
                cachedWorkflowConfig = {
                    ...payload,
                    script: statusResult.script_data,
                    api_claude_script_generation: statusResult.api_claude_script_generation,
                    api_claude_categorize_photos: statusResult.api_claude_categorize_photos,
                    api_claude_feature_identification: statusResult.api_claude_feature_identification
                };
                populateScriptEditor(cachedWorkflowConfig);
                showEditorStatus('Script regenerated! ‚ú®', 'success');
                return;
            } else if (statusResult.status === 'failed') {
                throw new Error(statusResult.error_message || 'Job failed');
            }
            
            const elapsed = (attempts + 1) * 3;
            showEditorStatus(`Regenerating script... ‚úçÔ∏è (${elapsed}s)`, 'loading');
            attempts++;
        }
        
        throw new Error('Timeout waiting for script generation');
        
    } catch (error) {
        console.error('Regenerate error:', error);
        showEditorStatus(`Error: ${error.message}`, 'error');
    } finally {
        lockEditor(false);
    }
}

async function approveAndGenerate() {
    if (!cachedWorkflowConfig) {
        showEditorStatus('No cached config found. Please regenerate the script.', 'error');
        return;
    }
    
    // Lock the editor immediately
    lockEditor(true);
    
    // Get the edited script values
    const editedHook = document.getElementById('editHook').value.trim();
    const editedBody = document.getElementById('editBody').value.trim();
    const editedCta = document.getElementById('editCta').value.trim();
    
    // Update the cached config with edited script
    const cleanText = (text) => text.replace(/\n+/g, ' ').replace(/\s+/g, ' ').trim();
    
    cachedWorkflowConfig.script = {
        ...cachedWorkflowConfig.script,
        hook: cleanText(editedHook),
        body: cleanText(editedBody),
        cta: cleanText(editedCta),
        segments: editedBody.split(/\n\n+/).map(s => cleanText(s)).filter(s => s),
        full_script: cleanText([editedHook, editedBody, editedCta].filter(s => s).join(' '))
    };
    
    cachedWorkflowConfig.script_edited = true;
    delete cachedWorkflowConfig.preview_mode;
    cachedWorkflowConfig.test_mode = originalTestMode;
    
    // Clear old API caches
    delete cachedWorkflowConfig.api_elevenlabs_tts;
    delete cachedWorkflowConfig.api_elevenlabs_forced_alignment;
    delete cachedWorkflowConfig.api_heygen_tts;
    delete cachedWorkflowConfig.audio_url;
    delete cachedWorkflowConfig.api_cloudinary_upload;
    
    console.log('Submitting approved config:', cachedWorkflowConfig);
    
    showEditorStatus('Starting video generation... ‚è±Ô∏è', 'loading');
    
    try {
        // Step 1: Start the job
        const startResponse = await fetch(WEBHOOK_URL + '/start', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(cachedWorkflowConfig)
        });
        
        const startResult = await startResponse.json();
        console.log('Video job started:', startResult);
        
        if (!startResponse.ok || !startResult.job_id) {
            throw new Error(startResult.message || 'Failed to start video job');
        }
        
        // Step 2: Poll for completion
        const jobId = startResult.job_id;
        let attempts = 0;
        const maxAttempts = 45; // 15 minutes max (45 * 20 seconds)
        
        while (attempts < maxAttempts) {
            await new Promise(resolve => setTimeout(resolve, 20000)); // Wait 20 seconds
            
            const statusResponse = await fetch(WEBHOOK_URL + '/status?job_id=' + jobId);
            const statusResult = await statusResponse.json();
            console.log('Video job status:', statusResult);
            
            if (statusResult.status === 'complete') {
                // Show success with video link and reset button
                let successHtml = 'üéâ Your video is ready!';
                if (statusResult.video_url) {
                    successHtml += ` <a href="${statusResult.video_url}" target="_blank">Click here to view</a>`;
                } else {
                    successHtml += ' Check your email!';
                }
                successHtml += '<br><br><button onclick="resetForm()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Create Another Video</button>';
                showEditorStatus(successHtml, 'success');
                
                // Keep editor locked but don't auto-reset
                return;
            } else if (statusResult.status === 'failed') {
                throw new Error(statusResult.error_message || 'Video generation failed');
            }
            
            // Show generic progress message with elapsed time
            const elapsed = Math.round((attempts + 1) * 20 / 60);
            showEditorStatus(`Generating video... This may take a few minutes ‚è≥ (~${elapsed} min)`, 'loading');
            attempts++;
        }
        
        throw new Error('Timeout waiting for video generation');
        
    } catch (error) {
        console.error('Generation error:', error);
        showEditorStatus(`Error: ${error.message}`, 'error');
        lockEditor(false); // Unlock on error so user can try again
    }
}

function showEditorStatus(message, type) {
    const statusDiv = document.getElementById('editorStatus');
    statusDiv.innerHTML = message; // Use innerHTML to support links
    statusDiv.className = `status ${type}`;
    statusDiv.style.display = 'block';
}

// Add event listeners for word count updates
document.getElementById('editHook').addEventListener('input', () => { updateWordCounts(); updateDurationEstimate(); });
document.getElementById('editBody').addEventListener('input', () => { updateWordCounts(); updateDurationEstimate(); });
document.getElementById('editCta').addEventListener('input', () => { updateWordCounts(); updateDurationEstimate(); });

// =====================
// ORIGINAL FORM FUNCTIONS
// =====================

function buildPayload() {
    const formData = new FormData(document.getElementById('adForm'));
    const client = formData.get('client');
    const template = formData.get('template');
    const topic = formData.get('topic');
    const platformValue = formData.get('platform');
    const theme = formData.get('theme') || '';
    const includeAnimation = formData.get('include_animation') === 'true';
    const avatarValue = formData.get('avatar');
    const email = formData.get('email');
    const scriptLength = formData.get('script_length');
    const testMode = document.getElementById('testMode').checked;

    // Parse platform value to extract platform and ratio (format: platform_ratio)
    const [platform, ratio] = platformValue.split('_');

    // Parse avatar (format: avatar_id|voice_id|chromakey_color|chromakey_sensitivity|avatar_name)
    const [avatar_id, voice_id, chromakey_color, chromakey_sensitivity, avatar_name] = avatarValue.split('|');

    const vins = [];
    for (let i = 1; i <= vehicleCount; i++) {
        const vin = formData.get(`vehicle${i}`);
        if (vin) vins.push(vin);
    }

    // Validate vehicles if NOT educational template
    if (template !== 'social-educational-1') {
        if (vins.length === 0) {
            showStatus('Please select at least one vehicle', 'error');
            return null;
        }
    }

    if (template === 'ad-single-item-spotlight-1' && vins.length > 1) {
        showStatus('Single Item Spotlight only supports 1 vehicle', 'error');
        return null;
    }

    return {
        client: client,
        template_id: template,
        ratio: ratio,
        theme: theme,
        topic: topic,
        platform: platform,
        include_animation: includeAnimation,
        avatar_id: avatar_id,
        voice_id: voice_id,
        chromakey_color: chromakey_color,
        chromakey_sensitivity: chromakey_sensitivity,
        avatar_name: avatar_name,
        script_length: scriptLength,
        email: email,
        vins: vins,
        test_mode: testMode
    };
}

async function loadInventory() {
    try {
        const response = await fetch(INVENTORY_SHEET);
        const text = await response.text();
        const json = JSON.parse(text.substr(47).slice(0, -2));

        inventory = json.table.rows.slice(1).map(row => {
            const cells = row.c;
            return {
                vin: cells[1]?.v || '',
                make: cells[4]?.v || '',
                model: cells[5]?.v || '',
                year: cells[6]?.v || '',
                price: cells[14]?.v || ''
            };
        }).filter(car => car.vin && car.year && car.make && car.model);

        inventory.sort((a, b) => b.year - a.year);

        console.log(`Loaded ${inventory.length} vehicles from inventory`);

        addVehicle();

    } catch (error) {
        console.error('Error loading inventory:', error);
        showStatus('Error loading vehicle inventory. Please refresh the page.', 'error');
    }
}

function addVehicle() {
    if (vehicleCount >= MAX_CARS) return;

    vehicleCount++;
    const container = document.getElementById('vehicleContainer');
    const vehicleGroup = document.createElement('div');
    vehicleGroup.className = 'vehicle-group';
    vehicleGroup.dataset.vehicleNum = vehicleCount;

    const select = document.createElement('select');
    select.name = `vehicle${vehicleCount}`;
    select.required = selectedTemplate !== 'social-educational-1';
    select.onchange = checkFormValidity;

    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'Select vehicle...';
    select.appendChild(defaultOption);

    vehicleGroup.appendChild(select);

    if (vehicleCount > 1) {
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'remove-vehicle';
        removeBtn.textContent = '‚àí';
        removeBtn.onclick = () => removeVehicle(vehicleCount);
        vehicleGroup.appendChild(removeBtn);
    }

    container.appendChild(vehicleGroup);
    populateVehicleDropdowns();
    checkFormValidity();
}

function populateVehicleDropdowns() {
    const selects = document.querySelectorAll('#vehicleContainer select');
    const selectedVins = Array.from(selects).map(s => s.value).filter(v => v);

    selects.forEach(select => {
        const currentValue = select.value;
        select.innerHTML = '<option value="">Select vehicle...</option>';

        inventory.forEach(car => {
            if (!selectedVins.includes(car.vin) || car.vin === currentValue) {
                const option = document.createElement('option');
                option.value = car.vin;
                option.textContent = `${car.year} ${car.make} ${car.model}, ${car.price} - ${car.vin}`;
                select.appendChild(option);
            }
        });

        if (currentValue) {
            select.value = currentValue;
        }
    });

    const addBtn = document.getElementById('addVehicleBtn');
    if (selectedTemplate === 'ad-single-item-spotlight-1') {
        addBtn.disabled = true;
    } else {
        addBtn.disabled = vehicleCount >= MAX_CARS;
    }
}

function removeVehicle(num) {
    if (vehicleCount <= 1) return;

    const vehicleGroup = document.querySelector(`[data-vehicle-num="${num}"]`);
    vehicleGroup.remove();
    vehicleCount--;

    const groups = document.querySelectorAll('.vehicle-group');
    groups.forEach((group, index) => {
        const newNum = index + 1;
        group.dataset.vehicleNum = newNum;
        const select = group.querySelector('select');
        select.name = `vehicle${newNum}`;
        const button = group.querySelector('.remove-vehicle');
        if (button) {
            button.onclick = () => removeVehicle(newNum);
        }
    });

    vehicleCount = groups.length;
    populateVehicleDropdowns();
}

function checkFormValidity() {
    const client = document.getElementById('client').value;
    const template = document.getElementById('template').value;
    const topic = document.getElementById('topic').value;
    const avatar = document.getElementById('avatar').value;
    const platform = document.getElementById('platform').value;
    const scriptLength = document.getElementById('scriptLength').value;
    const email = document.getElementById('email').value;
    const selects = document.querySelectorAll('#vehicleContainer select');
    const hasVehicles = Array.from(selects).some(s => s.value);
    
    const submitBtn = document.getElementById('submitBtn');
    const previewBtn = document.getElementById('previewBtn');
    
    let isValid = false;
    
    if (template === 'social-educational-1') {
        isValid = !!(client && template && topic && platform && scriptLength && avatar && email);
    } else {
        isValid = !!(client && template && platform && scriptLength && avatar && email && hasVehicles);
    }
    
    submitBtn.disabled = !isValid;
    previewBtn.disabled = !isValid;
}

document.getElementById('adForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const payload = buildPayload();
    if (!payload) return;

    console.log('Submitting payload:', payload);

    showStatus(`Generating your ad... This will take 10 minutes or less. ‚è±Ô∏è`, 'loading');

    document.getElementById('submitBtn').disabled = true;
    document.getElementById('previewBtn').disabled = true;

    try {
        const response = await fetch(WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (response.ok) {
            showStatus(`Success! Your ad is being generated. Check your email in a few minutes. üé¨`, 'success');
            setTimeout(() => {
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('previewBtn').disabled = false;
            }, 5000);
        } else {
            showStatus(`Error: ${result.message || 'Something went wrong'}`, 'error');
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('previewBtn').disabled = false;
        }
    } catch (error) {
        console.error('Submission error:', error);
        showStatus(`Error: ${error.message}`, 'error');
        document.getElementById('submitBtn').disabled = false;
        document.getElementById('previewBtn').disabled = false;
    }
});

function showStatus(message, type) {
    const statusDiv = document.getElementById('status');
    statusDiv.textContent = message;
    statusDiv.className = `status ${type}`;
    statusDiv.style.display = 'block';

    if (type !== 'loading') {
        setTimeout(() => {
            statusDiv.style.display = 'none';
        }, 5000);
    }
}

function hideStatus() {
    document.getElementById('status').style.display = 'none';
    document.getElementById('editorStatus').style.display = 'none';
}

async function suggestTopics() {
    const scriptLength = document.getElementById('scriptLength').value;
    const avatarName = document.getElementById('avatar').value.split("|").pop();
    const suggestionMode = document.querySelector('input[name="suggestionMode"]:checked').value;
    const topicGuidance = document.getElementById('topicGuidance').value.trim();
    const suggestBtn = document.getElementById('suggestTopicsBtn');
    const suggestionsDiv = document.getElementById('topicSuggestions');
    const suggestionsList = document.getElementById('suggestionsList');

    const lengthMap = {
        'quick': 'brief_15_30',
        'standard': 'standard_30_45',
        'detailed': 'detailed_45_60'
    };

    const targetLength = lengthMap[scriptLength];
    const guidanceText = suggestionMode === 'guided' ? topicGuidance : '';

    suggestBtn.disabled = true;
    suggestBtn.textContent = '‚è≥ Generating...';

    try {
        const response = await fetch(TOPIC_SUGGEST_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                target_length: targetLength,
                topic_guidance: guidanceText,
                avatar_name: avatarName
            })
        });

        const result = await response.json();

        if (response.ok && result.success) {
            suggestionsList.innerHTML = result.suggestions.map(topic => 
                `<div style="padding: 10px; margin-bottom: 8px; background: white; border-radius: 6px; cursor: pointer; border: 2px solid #e0e0e0; transition: all 0.2s;" 
                     onmouseover="this.style.borderColor='#667eea'; this.style.background='#f8f9ff';" 
                     onmouseout="this.style.borderColor='#e0e0e0'; this.style.background='white';"
                     onclick="document.getElementById('topic').value = '${topic.replace(/'/g, "\\'")}'; checkFormValidity(); document.getElementById('topicSuggestions').style.display='none';">
                    ${topic}
                </div>`
            ).join('');

            suggestionsDiv.style.display = 'block';
        } else {
            showStatus('Failed to generate suggestions. Please try again.', 'error');
        }
    } catch (error) {
        console.error('Suggestion error:', error);
        showStatus('Error generating suggestions. Please try again.', 'error');
    } finally {
        suggestBtn.disabled = false;
        if (topicGuidance.length > 1) {
            suggestBtn.textContent = 'üí° Suggest more topics related to ' + topicGuidance;
        } else {
            suggestBtn.textContent = 'üí° Suggest more topics';
        }
    }
}

function handleSuggestionModeChange() {
    const mode = document.querySelector('input[name="suggestionMode"]:checked').value;
    const guidanceContainer = document.getElementById('topicGuidanceContainer');

    if (mode === 'guided') {
        guidanceContainer.style.display = 'block';
    } else {
        guidanceContainer.style.display = 'none';
    }
}

function handleGuidanceChange() {
    const topicGuidance = document.getElementById('topicGuidance').value.trim();
    const suggestBtn = document.getElementById('suggestTopicsBtn');

    if (topicGuidance.length > 0) {
        suggestBtn.textContent = 'üí° Suggest topics related to ' + topicGuidance;
    } else {
        suggestBtn.textContent = 'üí° Suggest topics';
    }
}

function handleLengthChange() {
    const template = document.getElementById('template').value;
    const scriptLength = document.getElementById('scriptLength').value;
    const topicGroup = document.getElementById('topicGroup');
    const avatar = document.getElementById('avatar').value;

    if (template === 'social-educational-1' && scriptLength && avatar) {
        topicGroup.classList.remove('hidden');
    } else if (template === 'social-educational-1') {
        topicGroup.classList.add('hidden');
    }

    checkFormValidity();
}

// Add event listeners for form validation
document.getElementById('client').addEventListener('change', checkFormValidity);
document.getElementById('avatar').addEventListener('change', checkFormValidity);
document.getElementById('platform').addEventListener('change', checkFormValidity);
document.getElementById('email').addEventListener('input', checkFormValidity);
document.getElementById('scriptLength').addEventListener('change', checkFormValidity);

// Initialize on page load
loadInventory();
</script>
</body>
</html>




